<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>المدرسة السادسة والعشرون - تبوك</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap');

    :root{
      --primary:#10b981;--secondary:#059669;--dark:#047857;--light:#d1fae5;
      --accent:#fbbf24;--text:#0f172a;--gray:#64748b;--container:94vw;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 50%,#f0fdf4 100%);color:var(--text);line-height:1.6;min-height:100vh;overflow-x:hidden}

    /* الهيدر */
    .header-logo{background:#fff;position:sticky;top:0;z-index:1000;box-shadow:0 4px 12px rgba(16,185,129,.1);border-bottom:2px solid var(--light);padding:10px 0}
    .header-logo .wrap{width:var(--container);max-width:1200px;margin:0 auto;padding:0 16px;display:flex;justify-content:center;align-items:center}
    .header-logo img{height:70px;width:auto;object-fit:contain}

    /* التنقل */
    nav{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);position:sticky;top:0;z-index:999;box-shadow:0 4px 12px rgba(16,185,129,.2)}
    .nav{width:var(--container);max-width:1200px;margin:0 auto;display:flex;justify-content:center;gap:8px;padding:12px 16px;flex-wrap:wrap}
    .nav-btn{border:none;border-radius:20px;padding:10px 16px;font-weight:700;color:var(--primary);cursor:pointer;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:all .3s;font-size:14px;flex:1;min-width:110px;text-align:center}
    .nav-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .nav-btn.active{background:linear-gradient(135deg,var(--dark),var(--primary));color:#fff;transform:scale(1.05);box-shadow:0 6px 20px rgba(4,120,87,.4)}

    /* المحتوى */
    .container{width:var(--container);max-width:1200px;margin:0 auto;padding:20px 16px 120px}
    .page{display:none;background:#fff;padding:20px;border-radius:16px;box-shadow:0 8px 24px rgba(16,185,129,.1);margin-bottom:20px}
    .page.active{display:block;animation:slideIn .4s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    h1{color:var(--dark);text-align:center;margin:0 0 16px;font-size:24px;font-weight:900}
    h2{color:var(--primary);margin:20px 0 12px;font-size:20px;border-right:4px solid var(--accent);padding-right:10px;font-weight:800}
    .page p{text-align:center;font-size:16px;color:var(--gray);margin:16px 0;line-height:1.6}

    /* النماذج */
    .form{display:grid;gap:16px}
    .grid-2,.grid-3{display:grid;grid-template-columns:1fr;gap:12px}
    label{display:flex;flex-direction:column;gap:6px;color:#334155;font-weight:600;font-size:14px}
    .chipset{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);padding:8px 12px;border-radius:10px;border:2px solid var(--light);cursor:pointer;transition:all .3s;font-size:14px}
    .chip:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,.2)}
    .chip input[type="checkbox"]{width:16px;height:16px;accent-color:var(--primary);cursor:pointer}
    .input,select,textarea{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;background:#f8fafc;font-size:16px;transition:all .3s;font-family:'Tajawal',sans-serif}
    .input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 4px rgba(16,185,129,.1)}
    textarea{min-height:100px;resize:vertical}

    /* الأزرار */
    .btn{padding:12px 20px;border:none;border-radius:16px;color:#fff;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--primary),var(--secondary));box-shadow:0 4px 15px rgba(16,185,129,.3);transition:all .2s;font-size:14px;display:inline-block;text-align:center;width:100%}
    .btn:active{transform:scale(.98)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(16,185,129,.4)}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .actions{display:flex;flex-direction:column;gap:10px}

    /* رفع الصور */
    .upload{border:3px dashed var(--primary);border-radius:12px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);padding:16px;text-align:center;cursor:pointer;transition:all .3s}
    .upload:hover{background:linear-gradient(135deg,#dcfce7,#d1fae5)}
    .upload p{color:var(--primary);font-weight:800;margin:0 0 8px;font-size:14px}

    /* معاينة الصور */
    .witness-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .witness-grid img{width:100%;height:auto;object-fit:scale-down;border:none;box-shadow:none;background:transparent}
    .hint{text-align:center;color:var(--secondary);font-weight:600;margin-top:8px;font-size:13px}

    /* الجدول */
    .table-wrap{border-radius:10px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.05);overflow-x:auto;margin:12px 0}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:700px}
    th,td{padding:10px 8px;text-align:center;border-bottom:1px solid #f1f5f9;font-size:13px}
    th{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;font-size:12px}
    tbody tr:hover{background:#f0fdf4}
    tbody tr:nth-child(even){background:#f8fafc}

    /* الفوتر */
    .site-footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,var(--primary),var(--dark));color:#fff;padding:10px;text-align:center;box-shadow:0 -4px 20px rgba(0,0,0,.15);z-index:5}
    .site-footer p{margin:4px 0;font-size:12px}
    .site-footer strong{color:var(--accent)}

    /* التنبيهات */
    .toast{position:fixed;top:100px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:10px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:9999;font-size:14px;font-weight:700;animation:toastIn .3s ease;max-width:90%;text-align:center}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    .toast.err{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .toast.warn{background:linear-gradient(135deg,#f59e0b,#d97706)}

    /* التقويم الهجري */
    .date-with-hijri{position:relative}
    .date-input-container{position:relative;display:flex;align-items:center}
    .date-input-container .input{padding-right:50px;cursor:text}
    .hijri-toggle{position:absolute;left:10px;top:50%;transform:translateY(-50%);background:var(--light);border:none;border-radius:8px;cursor:pointer;padding:8px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;transition:all .3s;box-shadow:0 2px 6px rgba(16,185,129,.2)}
    .hijri-toggle:hover{background:var(--primary);transform:translateY(-50%) scale(1.05)}
    .hijri-toggle:hover .hijri-icon{fill:#fff}
    .hijri-icon{width:20px;height:20px;fill:var(--primary);transition:all .3s}

    .hijri-calendar{position:fixed;background:#fff;border-radius:16px;box-shadow:0 15px 40px rgba(0,0,0,.2);padding:20px;z-index:10000;width:90vw;max-width:360px;display:none;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid var(--light);max-height:80vh;overflow-y:auto}
    .hijri-calendar.active{display:block;animation:slideIn .3s ease}
    .hijri-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #e2e8f0}
    .hijri-month-year{font-weight:800;color:var(--dark);font-size:18px}
    .hijri-nav{display:flex;gap:8px}
    .hijri-nav button{background:var(--light);border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:bold;color:var(--dark);transition:all .2s;font-size:16px;display:flex;align-items:center;justify-content:center;width:36px;height:36px}
    .hijri-nav button:hover{background:var(--primary);color:#fff}
    .hijri-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-weight:800;margin-bottom:10px;color:var(--dark);font-size:14px;padding-bottom:10px;border-bottom:1px solid #f1f5f9}
    .hijri-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .hijri-day{padding:10px 5px;text-align:center;border-radius:8px;cursor:pointer;transition:all .2s;font-size:14px;font-weight:600}
    .hijri-day:hover{background:var(--light)}
    .hijri-day.selected{background:var(--primary);color:#fff}
    .hijri-day.today{background:var(--accent);color:#fff}
    .hijri-day.other-month{color:#94a3b8}
    .hijri-day.disabled{color:#cbd5e1;cursor:not-allowed}
    .hijri-day.disabled:hover{background:transparent}
    .calendar-actions{display:flex;gap:8px;margin-top:16px}
    .today-btn{flex:1;padding:10px;background:var(--light);color:var(--dark);border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;font-size:14px}
    .today-btn:hover{background:var(--primary);color:#fff}

    /* تحسينات للجوال */
    @media (max-width: 480px) {
      .hijri-month-year {
        font-size: 16px;
      }
      .hijri-day {
        padding: 8px 2px;
        font-size: 12px;
      }
      .hijri-nav button {
        width: 30px;
        height: 30px;
        padding: 5px;
      }
      .hijri-calendar {
        width: 95vw;
        padding: 15px;
      }
      .date-input-container .input {
        font-size: 14px;
      }
    }

    /* شاشات أكبر */
    @media (min-width:768px){
      .header-logo img{height:100px}
      .nav-btn{padding:12px 24px;font-size:15px;flex:0 1 auto}
      .container{padding:24px 16px 120px}
      .page{padding:32px;border-radius:20px}
      h1{font-size:32px;margin:0 0 20px}
      h2{font-size:22px;margin:24px 0 12px}
      .page p{font-size:18px}
      .grid-2{grid-template-columns:1fr 1fr}
      .grid-3{grid-template-columns:1fr 1fr 1fr}
      .btn{padding:14px 24px;width:auto}
      .actions{flex-direction:row}
      .witness-grid{grid-template-columns:repeat(4,1fr)}
      .witness-grid img{height:auto}
      .hijri-calendar{position:absolute;top:100%;right:0;left:auto;transform:none;width:340px;max-width:none}
    }
    @media (max-width:480px){
      .header-logo img{height:60px}
      .nav{gap:6px;padding:10px}
      .nav-btn{min-width:100px;padding:8px 12px;font-size:12px}
      .witness-grid img{height:auto}
    }
  </style>
</head>
<body>
  <header class="header-logo">
    <div class="wrap">
      <img src="https://raw.githubusercontent.com/omymh/school26/main/26.png" 
           alt="شعار المدرسة السادسة والعشرون" 
           onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMjAwIDgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxMGI5ODEiLz48dGV4dCB4PSIxMDAiIHk9IjQ1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk1hZGFyaXNhdCBBbC1TYWRpc2EgdyBBbHNoYXJvb248L3RleHQ+PC9zdmc+'; this.alt='شعار المدرسة السادسة والعشرون';">
    </div>
  </header>

  <nav>
    <div class="nav">
      <button class="nav-btn active" id="navHome" type="button">الصفحة الرئيسية</button>
      <button class="nav-btn" id="navReport" type="button">التقرير</button>
      <button class="nav-btn" id="navSessions" type="button">تقارير الحصص</button>
    </div>
  </nav>

  <main class="container">
    <section id="home" class="page active">
      <h1>نظام التقارير المدرسية</h1>
      <p>مرحباً بالمعلمات الكريمات في منصة المدرسة السادسة والعشرون بتبوك لتوثيق الأنشطة والحصص بكفاءة وسهولة.</p>
    </section>

    <section id="report" class="page">
      <h1>التقرير</h1>
      <form id="reportForm" class="form" onsubmit="return false;">
        <div class="grid-2">
          <label>اسم البرنامج *<input class="input" name="title" required></label>
          <label>المنفذ *<input class="input" name="owner" required></label>
          <label>عدد المستفيدين<input class="input" name="count" type="number" min="1"></label>

          <label class="date-with-hijri">التاريخ *
            <div class="date-input-container">
              <input class="input hijri-date-input" name="date" required placeholder="اختر التاريخ" readonly>
              <button type="button" class="hijri-toggle" aria-label="فتح التقويم">
                <svg class="hijri-icon" viewBox="0 0 24 24">
                  <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zM7 12h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
              </button>
            </div>
            <div class="hijri-calendar">
              <div class="hijri-header">
                <div class="hijri-nav">
                  <button type="button" class="prev-year">«</button>
                  <button type="button" class="prev-month">‹</button>
                </div>
                <div class="hijri-month-year"></div>
                <div class="hijri-nav">
                  <button type="button" class="next-month">›</button>
                  <button type="button" class="next-year">»</button>
                </div>
              </div>
              <div class="hijri-weekdays">
                <span>س</span><span>ح</span><span>ن</span><span>ث</span><span>ر</span><span>خ</span><span>ج</span>
              </div>
              <div class="hijri-days"></div>
              <div class="calendar-actions">
                <button type="button" class="today-btn">اليوم</button>
                <button type="button" class="btn danger" id="closeCalendar" style="flex:1">إغلاق</button>
              </div>
            </div>
          </label>

          <label>المكان<input class="input" name="place"></label>
        </div>

        <label>الأهداف<textarea class="input" name="goals"></textarea></label>
        <label>وصف التقرير<textarea class="input" name="desc"></textarea></label>

        <div>
          <div class="upload" id="uploadBox">
            <p>اضغطي هنا لرفع صور الشواهد (حد أقصى 4)</p>
            <input type="file" id="witnessFiles" accept="image/*" multiple hidden>
            <button class="btn" type="button" id="addWitness">إضافة الشواهد</button>
          </div>
          <div id="witnessPreview" class="witness-grid"></div>
          <div class="actions" style="margin-top:16px">
            <button class="btn" type="button" id="exportReport">تصدير PDF</button>
            <button class="btn danger" type="button" id="clearWitness">حذف الصور</button>
          </div>
          <div class="hint" id="wCount">(0/4)</div>
        </div>
      </form>
    </section>

    <section id="sessions" class="page">
      <h1>تقرير حصص الانتظار</h1>
      <form id="sesForm" class="form" onsubmit="return false;">
        <label>اسم المعلمة<input class="input" id="reportTeacher"></label>

        <div class="grid-3">
          <label>الأسبوع *<select class="input" id="weekNumber" required>
            <option value="">اختر الأسبوع</option>
            <option>الأسبوع الأول</option><option>الأسبوع الثاني</option><option>الأسبوع الثالث</option>
            <option>الأسبوع الرابع</option><option>الأسبوع الخامس</option><option>الأسبوع السادس</option>
            <option>الأسبوع السابع</option><option>الأسبوع الثامن</option><option>الأسبوع التاسع</option>
            <option>الأسبوع العاشر</option><option>الأسبوع الحادي عشر</option><option>الأسبوع الثاني عشر</option>
            <option>الأسبوع الثالث عشر</option>
          </select></label>

          <label>اليوم *<select class="input" id="dayName" required>
            <option value="">اختر اليوم</option>
            <option>الأحد</option><option>الاثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
          </select></label>

          <label class="date-with-hijri">التاريخ *
            <div class="date-input-container">
              <input class="input hijri-date-input" id="sessionDate" required placeholder="اختر التاريخ" readonly>
              <button type="button" class="hijri-toggle" aria-label="فتح التقويم">
                <svg class="hijri-icon" viewBox="0 0 24 24">
                  <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zM7 12h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
              </button>
            </div>
            <div class="hijri-calendar">
              <div class="hijri-header">
                <div class="hijri-nav">
                  <button type="button" class="prev-year">«</button>
                  <button type="button" class="prev-month">‹</button>
                </div>
                <div class="hijri-month-year"></div>
                <div class="hijri-nav">
                  <button type="button" class="next-month">›</button>
                  <button type="button" class="next-year">»</button>
                </div>
              </div>
              <div class="hijri-weekdays">
                <span>س</span><span>ح</span><span>ن</span><span>ث</span><span>ر</span><span>خ</span><span>ج</span>
              </div>
              <div class="hijri-days"></div>
              <div class="calendar-actions">
                <button type="button" class="today-btn">اليوم</button>
                <button type="button" class="btn danger" id="closeCalendar" style="flex:1">إغلاق</button>
              </div>
            </div>
          </label>

          <label>الصف *<input class="input" id="className" required></label>
          <label>رقم الحصة *<input class="input" id="sessionNumber" required></label>
          <label>المعلمة الغائبة *<input class="input" id="absentTeacher" required></label>
        </div>

        <label>ما تم تنفيذه *<textarea class="input" id="activitiesText" required></textarea></label>

        <div class="chipset">
          <label class="chip"><input type="checkbox" id="basicSkills"> المهارات الأساسية</label>
          <label class="chip"><input type="checkbox" id="values"> القيم والمواطنة الصالحة</label>
          <label class="chip"><input type="checkbox" id="futureSkills"> مهارات المستقبل</label>
        </div>

        <div>
          <h2>صور الشواهد</h2>
          <div class="upload" id="sessionUploadBox">
            <p>اضغطي هنا لرفع صور الشواهد (حد أقصى 4)</p>
            <input type="file" id="sessionWitnessFiles" accept="image/*" multiple hidden>
            <button class="btn" type="button" id="addSessionWitness">إضافة الشواهد</button>
          </div>
          <div id="sessionWitnessPreview" class="witness-grid"></div>
          <div class="hint" id="sessionWCount">(0/4)</div>
        </div>

        <div class="actions">
          <button class="btn" type="button" id="saveSession">حفظ الحصة</button>
          <button class="btn" type="button" id="exportSessions">تصدير PDF</button>
          <button class="btn danger" type="button" id="clearAll">مسح الكل</button>
        </div>
      </form>

      <h2>الحصص المسجلة</h2>
      <div class="table-wrap">
        <table id="sessionsTable">
          <thead>
          <tr>
            <th style="width:40px">م</th><th style="width:80px">الأسبوع</th><th style="width:80px">اليوم</th>
            <th style="width:100px">التاريخ</th><th>الصف</th><th style="width:60px">الحصة</th>
            <th style="width:140px">المعلمة الغائبة</th><th style="min-width:200px">ما تم تنفيذه</th>
            <th style="min-width:140px">المجال</th><th class="no-print" style="width:80px">إجراء</th>
          </tr>
          </thead>
          <tbody id="sessionsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <p><strong>مديرة المدرسة:</strong> أماني آل عبشان</p>
    <p><strong>تصميم الهيئة الإدارية:</strong> عيدة صلاح، منيرة العمراني</p>
  </footer>

  <!-- إضافة مكتبات PDF مع دعم اللغة العربية -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hijri-date/lib/hijri-date.min.js"></script>

  <script>
    // ============== بيانات عامة ==============
    let witness = [];
    let sessionWitness = [];
    let sessions = [];

    // ============== دوال معالجة النصوص العربية ==============
    
    // دالة لإزالة التشكيل من النص العربي
    function removeDiacritics(text) {
      if (!text) return '';
      
      // نطاقات الحروف المشكّلة في Unicode
      const diacriticsRanges = [
        [0x064B, 0x065F], // التشكيل الأساسي
        [0x0670, 0x0670], // السكون الخاص
        [0x0610, 0x061A], // تشكيل إضافي
        [0x06D6, 0x06DC], // تشكيل ممتد
        [0x06DF, 0x06E8], // تشكيل ممتد
        [0x06EA, 0x06ED]  // تشكيل ممتد
      ];
      
      let result = '';
      for (let i = 0; i < text.length; i++) {
        const charCode = text.charCodeAt(i);
        let isDiacritic = false;
        
        for (const [start, end] of diacriticsRanges) {
          if (charCode >= start && charCode <= end) {
            isDiacritic = true;
            break;
          }
        }
        
        if (!isDiacritic) {
          result += text[i];
        }
      }
      
      return result;
    }
    
    // دالة لعكس النص العربي ليظهر بشكل صحيح
    function reverseArabicText(text) {
      if (!text) return '';
      
      // فصل النص إلى كلمات
      const words = text.split(' ');
      const reversedWords = [];
      
      for (const word of words) {
        // فصل الحروف والأرقام والرموز
        const characters = [];
        let currentSegment = '';
        let isNumber = false;
        
        for (let i = 0; i < word.length; i++) {
          const char = word[i];
          const charCode = word.charCodeAt(i);
          
          // التحقق إذا كان الحرف رقمًا أو رمزًا إنجليزيًا
          const isEnglishOrNumber = (charCode >= 48 && charCode <= 57) || // 0-9
                                   (charCode >= 65 && charCode <= 90) || // A-Z
                                   (charCode >= 97 && charCode <= 122);  // a-z
          
          if (i === 0) {
            isNumber = isEnglishOrNumber;
            currentSegment += char;
          } else {
            if (isEnglishOrNumber === isNumber) {
              currentSegment += char;
            } else {
              characters.push(currentSegment);
              currentSegment = char;
              isNumber = isEnglishOrNumber;
            }
          }
        }
        
        if (currentSegment) {
          characters.push(currentSegment);
        }
        
        // عكس ترتيب المقاطع مع الحفاظ على اتجاه الأرقام والإنجليزية
        const reversedCharacters = [];
        for (const segment of characters) {
          const firstCharCode = segment.charCodeAt(0);
          const isEnglishOrNumber = (firstCharCode >= 48 && firstCharCode <= 57) ||
                                   (firstCharCode >= 65 && firstCharCode <= 90) ||
                                   (firstCharCode >= 97 && firstCharCode <= 122);
          
          if (isEnglishOrNumber) {
            reversedCharacters.push(segment);
          } else {
            reversedCharacters.push(segment.split('').reverse().join(''));
          }
        }
        
        reversedWords.push(reversedCharacters.reverse().join(''));
      }
      
      return reversedWords.reverse().join(' ');
    }
    
    // الدالة الرئيسية لتحضير النص العربي
    function prepareArabicText(text) {
      if (!text) return '';
      
      // إزالة التشكيل أولاً
      const cleanText = removeDiacritics(text);
      
      // ثم عكس النص
      return reverseArabicText(cleanText);
    }

    // ============== دالة تحويل التاريخ الميلادي إلى هجري ==============
    function gregorianToHijri(gregorianDate) {
      try {
        if (typeof HijriDate !== 'undefined') {
          const hijriDate = new HijriDate(gregorianDate);
          return {
            day: hijriDate.getDate(),
            month: hijriDate.getMonth() + 1,
            year: hijriDate.getFullYear()
          };
        }
      } catch (e) {
        console.log('مكتبة Hijri-Date غير متاحة، استخدام الخوارزمية المحلية');
      }
      
      // خوارزمية احتياطية
      const gd = gregorianDate.getDate();
      const gm = gregorianDate.getMonth() + 1;
      const gy = gregorianDate.getFullYear();

      const jd = Math.floor((1461 * (gy + 4800 + Math.floor((gm - 14) / 12))) / 4) +
                 Math.floor((367 * (gm - 2 - 12 * Math.floor((gm - 14) / 12))) / 12) -
                 Math.floor((3 * Math.floor((gy + 4900 + Math.floor((gm - 14) / 12)) / 100)) / 4) +
                 gd - 32075;

      const l = jd - 1948440 + 10632;
      const n = Math.floor((l - 1) / 10631);
      const ll = l - 10631 * n + 354;
      const j = (Math.floor((10985 - ll) / 5316)) * (Math.floor((50 * ll) / 17719)) + 
                (Math.floor(ll / 5670)) * (Math.floor((43 * ll) / 15238));
      const lll = ll - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - 
                  (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
      
      const hm = Math.floor((24 * lll) / 709);
      const hd = lll - Math.floor((709 * hm) / 24);
      const hy = 30 * n + j - 30;

      return { day: hd, month: hm, year: hy };
    }

    function hijriToGregorian(hd, hm, hy) {
      try {
        if (typeof HijriDate !== 'undefined') {
          const hijriDate = new HijriDate(hy, hm - 1, hd);
          return hijriDate.toGregorian();
        }
      } catch (e) {
        console.log('مكتبة Hijri-Date غير متاحة، استخدام الخوارزمية المحلية');
      }
      
      // خوارزمية احتياطية
      const jd = Math.floor((11 * hy + 3) / 30) + 
                 Math.floor(354 * hy) + 
                 Math.floor(30 * hm) - 
                 Math.floor((hm - 1) / 2) + 
                 hd + 1948440 - 385;
      
      const l = jd + 68569;
      const n = Math.floor((4 * l) / 146097);
      const ll = l - Math.floor((146097 * n + 3) / 4);
      const i = Math.floor((4000 * (ll + 1)) / 1461001);
      const lll = ll - Math.floor((1461 * i) / 4) + 31;
      const jj = Math.floor((80 * lll) / 2447);
      const gd = lll - Math.floor((2447 * jj) / 80);
      const llll = Math.floor(jj / 11);
      const gm = jj + 2 - 12 * llll;
      const gy = 100 * (n - 49) + i + llll;

      return new Date(gy, gm - 1, gd);
    }

    // أسماء الأشهر الهجرية
    const HIJRI_MONTHS = [
      "محرم","صفر","ربيع الأول","ربيع الآخر",
      "جمادى الأولى","جمادى الآخرة","رجب",
      "شعبان","رمضان","شوال","ذو القعدة","ذو الحجة"
    ];

    document.addEventListener('DOMContentLoaded', () => {
      loadSessions();
      initializeNavigation();
      initializeWitnessManagement();
      initializeSessionWitnessManagement();
      initializeReportExport();
      initializeSessionManagement();
      initializeSessionsExport();
      initializeHijriCalendar();
    });

    function loadSessions(){
      try{
        const saved = localStorage.getItem('sessionsData');
        if(saved){ sessions = JSON.parse(saved); renderSessions(); }
      }catch(e){ console.log('لا توجد بيانات محفوظة'); }
    }

    function showToast(message,type=''){
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(()=>{toast.style.opacity='0';toast.style.transition='opacity .3s ease';},1400);
      setTimeout(()=>{toast.remove();},1900);
    }

    // ============== التنقل بين الصفحات ==============
    function initializeNavigation(){
      const btns = {
        home: document.getElementById('navHome'),
        report: document.getElementById('navReport'),
        sessions: document.getElementById('navSessions')
      };
      btns.home.addEventListener('click', ()=>{showPage('home'); setActiveNav(btns.home);});
      btns.report.addEventListener('click', ()=>{showPage('report'); setActiveNav(btns.report);});
      btns.sessions.addEventListener('click', ()=>{showPage('sessions'); setActiveNav(btns.sessions);});
    }
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const t = document.getElementById(id);
      if(t) t.classList.add('active');
    }
    function setActiveNav(active){
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      active.classList.add('active');
    }

    // ============== إدارة الشواهد (التقرير) ==============
    function initializeWitnessManagement(){
      const files = document.getElementById('witnessFiles');
      const preview = document.getElementById('witnessPreview');
      const count = document.getElementById('wCount');

      const openPicker = ()=>files.click();
      document.getElementById('uploadBox').addEventListener('click', openPicker);
      document.getElementById('addWitness').addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();openPicker();});

      files.addEventListener('change', (e)=>{
        const list = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/')).slice(0, 4 - witness.length);
        if(list.length===0) return;
        let processed=0;
        list.forEach(file=>{
          if(witness.length>=4) return;
          const reader = new FileReader();
          reader.onload = (ev)=>{
            witness.push({name:file.name,url:ev.target.result});
            const img=document.createElement('img'); img.src=ev.target.result; img.alt='شاهد التقرير';
            preview.appendChild(img);
            processed++;
            if(processed===list.length){ count.textContent=`(${witness.length}/4)`; showToast('تم تحميل الشواهد'); }
          };
          reader.readAsDataURL(file);
        });
      });

      document.getElementById('clearWitness').addEventListener('click',(e)=>{
        e.preventDefault();
        if(witness.length===0){ showToast('لا توجد صور','warn'); return; }
        if(!confirm('حذف جميع صور الشواهد؟')) return;
        witness=[]; files.value=''; preview.innerHTML=''; count.textContent='(0/4)'; showToast('تم الحذف');
      });
    }

    // ============== إدارة شواهد الحصص ==============
    function initializeSessionWitnessManagement(){
      const files = document.getElementById('sessionWitnessFiles');
      const preview = document.getElementById('sessionWitnessPreview');
      const count = document.getElementById('sessionWCount');

      const openPicker = ()=>files.click();
      document.getElementById('sessionUploadBox').addEventListener('click', openPicker);
      document.getElementById('addSessionWitness').addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();openPicker();});

      files.addEventListener('change', (e)=>{
        const list = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/')).slice(0, 4 - sessionWitness.length);
        if(list.length===0) return;
        let processed=0;
        list.forEach(file=>{
          if(sessionWitness.length>=4) return;
          const reader = new FileReader();
          reader.onload = (ev)=>{
            sessionWitness.push({name:file.name,url:ev.target.result});
            const img=document.createElement('img'); img.src=ev.target.result; img.alt='شاهد الحصة';
            preview.appendChild(img);
            processed++;
            if(processed===list.length){ count.textContent=`(${sessionWitness.length}/4)`; showToast('تم تحميل الشواهد'); }
          };
          reader.readAsDataURL(file);
        });
      });

      // زر حذف
      const clearBtn=document.createElement('button');
      clearBtn.className='btn danger'; clearBtn.type='button'; clearBtn.textContent='حذف الصور';
      clearBtn.addEventListener('click',(e)=>{
        e.preventDefault();
        if(sessionWitness.length===0){ showToast('لا توجد صور','warn'); return; }
        if(!confirm('حذف جميع صور الشواهد؟')) return;
        sessionWitness=[]; files.value=''; preview.innerHTML=''; count.textContent='(0/4)'; showToast('تم الحذف');
      });
      document.querySelector('#sessionUploadBox').parentNode.appendChild(clearBtn);
    }

    // ============== تصدير تقرير البرنامج ==============
    function initializeReportExport(){
      document.getElementById('exportReport').addEventListener('click', async (e)=>{
        e.preventDefault();
        const form = document.getElementById('reportForm');
        const data = Object.fromEntries(new FormData(form));
        if(!data.title || !data.owner || !data.date){ showToast('أكمل الحقول الأساسية (*)','warn'); return; }

        try{
          showToast('جاري التصدير...','warn');

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
          });
          
          // إعدادات الصفحة
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const margin = 20;
          const contentWidth = pageWidth - 2 * margin;
          
          let yPosition = margin;
          
          // دالة لإضافة صفحة جديدة
          const addNewPage = () => {
            pdf.addPage();
            yPosition = margin;
          };
          
          // دالة للتحقق من المساحة وإضافة صفحة جديدة إذا لزم الأمر
          const checkSpace = (neededHeight) => {
            if (yPosition + neededHeight > pageHeight - margin) {
              addNewPage();
              return true;
            }
            return false;
          };
          
          // العنوان الرئيسي - استخدام النص العربي المعالج
          pdf.setFontSize(16);
          pdf.setFont('helvetica', 'bold');
          pdf.text(prepareArabicText('المملكة العربية السعودية'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('وزارة التعليم'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('الإدارة العامة للتعليم بمنطقة تبوك'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('المدرسة السادسة والعشرون'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 15;
          
          // عنوان التقرير
          pdf.setFontSize(20);
          pdf.setTextColor(4, 120, 87);
          pdf.text(prepareArabicText('التقرير'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 20;
          
          // جدول المعلومات باستخدام AutoTable
          const tableData = [
            [prepareArabicText('اسم البرنامج'), prepareArabicText(data.title || '')],
            [prepareArabicText('المنفذ'), prepareArabicText(data.owner || '')],
            [prepareArabicText('عدد المستفيدين'), prepareArabicText(data.count || 'غير محدد')],
            [prepareArabicText('التاريخ'), prepareArabicText(data.date || '')],
            [prepareArabicText('المكان'), prepareArabicText(data.place || 'غير محدد')]
          ];
          
          pdf.autoTable({
            startY: yPosition,
            head: [[prepareArabicText('المعلومة'), prepareArabicText('القيمة')]],
            body: tableData,
            theme: 'grid',
            styles: {
              font: 'helvetica',
              fontSize: 12,
              cellPadding: 5,
              lineColor: [200, 200, 200],
              lineWidth: 0.1,
            },
            headStyles: {
              fillColor: [16, 185, 129],
              textColor: [255, 255, 255],
              fontStyle: 'bold',
            },
            alternateRowStyles: {
              fillColor: [240, 253, 244]
            }
          });
          
          yPosition = pdf.lastAutoTable.finalY + 15;
          
          // الأهداف
          if (data.goals) {
            checkSpace(30);
            pdf.setFontSize(14);
            pdf.setTextColor(4, 120, 87);
            pdf.text(prepareArabicText('الأهداف'), margin, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            const goalsLines = pdf.splitTextToSize(prepareArabicText(data.goals), contentWidth - 10);
            goalsLines.forEach(line => {
              checkSpace(6);
              pdf.text(line, margin + 5, yPosition);
              yPosition += 6;
            });
            yPosition += 10;
          }
          
          // وصف التقرير
          if (data.desc) {
            checkSpace(30);
            pdf.setFontSize(14);
            pdf.setTextColor(4, 120, 87);
            pdf.text(prepareArabicText('وصف التقرير'), margin, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            const descLines = pdf.splitTextToSize(prepareArabicText(data.desc), contentWidth - 10);
            descLines.forEach(line => {
              checkSpace(6);
              pdf.text(line, margin + 5, yPosition);
              yPosition += 6;
            });
            yPosition += 10;
          }
          
          // صور الشواهد
          if (witness.length > 0) {
            checkSpace(30);
            pdf.setFontSize(16);
            pdf.setTextColor(4, 120, 87);
            pdf.text(prepareArabicText('صور الشواهد'), pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // معالجة الصور
            for (let i = 0; i < witness.length; i++) {
              const img = new Image();
              img.src = witness[i].url;
              
              await new Promise((resolve) => {
                img.onload = () => {
                  // التحقق من المساحة وإضافة صفحة جديدة إذا لزم الأمر
                  if (i % 2 === 0 && i > 0) {
                    addNewPage();
                    pdf.setFontSize(14);
                    pdf.setTextColor(4, 120, 87);
                    pdf.text(prepareArabicText('صور الشواهد (تابع)'), pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 15;
                  }
                  
                  // حجم الصورة الموحد 80x80 مم
                  const imgWidth = 80;
                  const imgHeight = 80;
                  const xPosition = (i % 2 === 0) ? margin + 10 : margin + contentWidth / 2 + 10;
                  
                  // التحقق من المساحة للصورة
                  if (checkSpace(imgHeight + 20)) {
                    pdf.setFontSize(14);
                    pdf.setTextColor(4, 120, 87);
                    pdf.text(prepareArabicText('صور الشواهد (تابع)'), pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 15;
                  }
                  
                  // رسم إطار للصورة
                  pdf.setDrawColor(200, 200, 200);
                  pdf.setLineWidth(0.5);
                  pdf.rect(xPosition - 2, yPosition - 2, imgWidth + 4, imgHeight + 4);
                  
                  // حساب أبعاد الصورة مع الحفاظ على التناسب
                  const aspectRatio = img.width / img.height;
                  let finalWidth = imgWidth;
                  let finalHeight = imgHeight;
                  let xOffset = 0;
                  let yOffset = 0;
                  
                  if (aspectRatio > 1) {
                    // صورة أفقية
                    finalHeight = imgWidth / aspectRatio;
                    yOffset = (imgHeight - finalHeight) / 2;
                  } else {
                    // صورة رأسية
                    finalWidth = imgHeight * aspectRatio;
                    xOffset = (imgWidth - finalWidth) / 2;
                  }
                  
                  // إضافة الصورة في وسط الإطار
                  pdf.addImage(img, 'JPEG', xPosition + xOffset, yPosition + yOffset, finalWidth, finalHeight);
                  
                  // نص تحت الصورة
                  pdf.setFontSize(10);
                  pdf.setTextColor(100, 116, 139);
                  pdf.text(prepareArabicText(`شاهد ${i + 1}`), xPosition + imgWidth / 2, yPosition + imgHeight + 8, { align: 'center' });
                  
                  // إذا كانت هذه الصورة الثانية في الصف، ننتقل للسطر التالي
                  if (i % 2 === 1) {
                    yPosition += imgHeight + 25;
                  }
                  
                  resolve();
                };
                
                img.onerror = () => {
                  console.log('فشل تحميل الصورة:', witness[i].name);
                  resolve();
                };
              });
            }
          }
          
          // حفظ الملف
          const fileName = `report_${data.title || 'school'}.pdf`;
          pdf.save(fileName);
          showToast('تم التصدير بنجاح');
        }catch(err){
          console.error(err); 
          showToast('حدث خطأ أثناء التصدير','err');
        }
      });
    }

    // ============== إدارة سجلات الحصص ==============
    function renderSessions(){
      const body = document.getElementById('sessionsBody'); if(!body) return;
      body.innerHTML='';
      sessions.forEach((s,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td><td>${s.week||''}</td><td>${s.day||''}</td><td>${s.date||''}</td>
          <td>${s.className||''}</td><td>${s.number||''}</td><td>${s.teacher||''}</td>
          <td style="text-align:right">${s.activities||''}</td><td style="text-align:right">${s.fields||''}</td>
          <td class="no-print"><button class="btn danger" type="button" data-index="${i}">حذف</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('button[data-index]').forEach(b=>{
        b.addEventListener('click',function(){
          const idx = +this.getAttribute('data-index');
          deleteSession(idx);
        });
      });
    }
    function deleteSession(index){
      if(!confirm('حذف هذه الحصة؟')) return;
      sessions.splice(index,1);
      try{ localStorage.setItem('sessionsData',JSON.stringify(sessions)); }catch(e){}
      renderSessions();
      showToast('تم الحذف');
    }
    function initializeSessionManagement(){
      document.getElementById('saveSession').addEventListener('click',(e)=>{
        e.preventDefault();
        const week = document.getElementById('weekNumber').value;
        const day = document.getElementById('dayName').value;
        const date = document.getElementById('sessionDate').value;
        const className = document.getElementById('className').value.trim();
        const number = document.getElementById('sessionNumber').value.trim();
        const teacher = document.getElementById('absentTeacher').value.trim();
        const activities = document.getElementById('activitiesText').value.trim();

        const fields=[];
        if(document.getElementById('basicSkills').checked) fields.push('المهارات الأساسية');
        if(document.getElementById('values').checked) fields.push('القيم والمواطنة الصالحة');
        if(document.getElementById('futureSkills').checked) fields.push('مهارات المستقبل');

        if(!week || !day || !date || !className || !number || !teacher || !activities || fields.length===0){
          showToast('أكمل كل الحقول واختر مجالاً واحداً على الأقل','warn'); return;
        }

        sessions.push({week,day,date,className,number,teacher,activities,fields:fields.join('، '),witness:[...sessionWitness]});
        try{ localStorage.setItem('sessionsData',JSON.stringify(sessions)); }catch(e){}
        renderSessions(); showToast('تم حفظ الحصة');

        document.getElementById('sesForm').reset();
        sessionWitness=[]; document.getElementById('sessionWitnessPreview').innerHTML=''; document.getElementById('sessionWCount').textContent='(0/4)';
      });

      document.getElementById('clearAll').addEventListener('click',(e)=>{
        e.preventDefault();
        if(sessions.length===0){ showToast('لا توجد حصص','warn'); return; }
        if(!confirm('مسح جميع الحصص؟')) return;
        sessions=[]; try{ localStorage.setItem('sessionsData',JSON.stringify(sessions)); }catch(e){}
        renderSessions(); showToast('تم المسح');
      });
    }

    // ============== تصدير تقرير الحصص ==============
    function initializeSessionsExport(){
      const btn=document.getElementById('exportSessions'); if(!btn) return;
      btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if(!Array.isArray(sessions) || sessions.length===0){ showToast('لا توجد حصص للتصدير','warn'); return; }
        try{
          showToast('جاري التصدير...','warn');

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
          });
          
          // إعدادات الصفحة
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const margin = 15;
          const contentWidth = pageWidth - 2 * margin;
          
          let yPosition = margin;
          
          // دالة لإضافة صفحة جديدة
          const addNewPage = () => {
            pdf.addPage();
            yPosition = margin;
          };
          
          // دالة للتحقق من المساحة وإضافة صفحة جديدة إذا لزم الأمر
          const checkSpace = (neededHeight) => {
            if (yPosition + neededHeight > pageHeight - margin) {
              addNewPage();
              return true;
            }
            return false;
          };
          
          // العنوان الرئيسي
          pdf.setFontSize(16);
          pdf.setFont('helvetica', 'bold');
          pdf.text(prepareArabicText('المملكة العربية السعودية'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('وزارة التعليم'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('الإدارة العامة للتعليم بمنطقة تبوك'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 8;
          pdf.text(prepareArabicText('المدرسة السادسة والعشرون'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 15;
          
          // عنوان التقرير
          pdf.setFontSize(20);
          pdf.setTextColor(4, 120, 87);
          pdf.text(prepareArabicText('تقرير حصص الانتظار'), pageWidth / 2, yPosition, { align: 'center' });
          yPosition += 20;
          
          // جدول الحصص باستخدام AutoTable
          const tableData = sessions.map((session, index) => [
            (index + 1).toString(),
            prepareArabicText(session.week || ''),
            prepareArabicText(session.day || ''),
            prepareArabicText(session.date || ''),
            prepareArabicText(session.className || ''),
            prepareArabicText(session.number || ''),
            prepareArabicText(session.teacher || ''),
            prepareArabicText(session.activities || ''),
            prepareArabicText(session.fields || '')
          ]);
          
          pdf.autoTable({
            startY: yPosition,
            head: [[
              prepareArabicText('م'),
              prepareArabicText('الأسبوع'),
              prepareArabicText('اليوم'),
              prepareArabicText('التاريخ'),
              prepareArabicText('الصف'),
              prepareArabicText('الحصة'),
              prepareArabicText('المعلمة الغائبة'),
              prepareArabicText('ما تم تنفيذه'),
              prepareArabicText('المجال')
            ]],
            body: tableData,
            theme: 'grid',
            styles: {
              font: 'helvetica',
              fontSize: 8,
              cellPadding: 3,
              lineColor: [200, 200, 200],
              lineWidth: 0.1,
            },
            headStyles: {
              fillColor: [16, 185, 129],
              textColor: [255, 255, 255],
              fontStyle: 'bold',
            },
            alternateRowStyles: {
              fillColor: [240, 253, 244]
            },
            columnStyles: {
              0: { cellWidth: 10 },
              1: { cellWidth: 25 },
              2: { cellWidth: 25 },
              3: { cellWidth: 25 },
              4: { cellWidth: 25 },
              5: { cellWidth: 15 },
              6: { cellWidth: 35 },
              7: { cellWidth: 60 },
              8: { cellWidth: 35 }
            }
          });
          
          yPosition = pdf.lastAutoTable.finalY + 10;
          
          // صور الشواهد للحصص
          const sessionsWithWitness = sessions.filter(s => s.witness && s.witness.length > 0);
          if (sessionsWithWitness.length > 0) {
            checkSpace(30);
            pdf.setFontSize(16);
            pdf.setTextColor(4, 120, 87);
            pdf.text(prepareArabicText('صور الشواهد للحصص'), pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // معالجة الصور لكل حصة
            for (let sIndex = 0; sIndex < sessionsWithWitness.length; sIndex++) {
              const session = sessionsWithWitness[sIndex];
              
              // عنوان الحصة
              checkSpace(20);
              pdf.setFontSize(12);
              pdf.setTextColor(5, 150, 105);
              pdf.text(prepareArabicText(`الحصة ${sIndex + 1}: ${session.className || ''} - ${session.date || ''}`), margin, yPosition);
              yPosition += 10;
              
              // معالجة صور هذه الحصة
              for (let i = 0; i < session.witness.length; i++) {
                const img = new Image();
                img.src = session.witness[i].url;
                
                await new Promise((resolve) => {
                  img.onload = () => {
                    // التحقق من المساحة وإضافة صفحة جديدة إذا لزم الأمر
                    if (i % 3 === 0 && i > 0) {
                      addNewPage();
                      pdf.setFontSize(12);
                      pdf.setTextColor(5, 150, 105);
                      pdf.text(prepareArabicText(`الحصة ${sIndex + 1}: ${session.className || ''} - ${session.date || ''} (تابع)`), margin, yPosition);
                      yPosition += 10;
                    }
                    
                    // حجم الصورة الموحد 70x70 مم للحصص
                    const imgWidth = 70;
                    const imgHeight = 70;
                    const imagesPerRow = 3;
                    const xSpacing = (contentWidth - (imgWidth * imagesPerRow)) / (imagesPerRow - 1);
                    const xPosition = margin + (i % imagesPerRow) * (imgWidth + xSpacing);
                    
                    // التحقق من المساحة للصورة
                    if (checkSpace(imgHeight + 25)) {
                      pdf.setFontSize(12);
                      pdf.setTextColor(5, 150, 105);
                      pdf.text(prepareArabicText(`الحصة ${sIndex + 1}: ${session.className || ''} - ${session.date || ''} (تابع)`), margin, yPosition);
                      yPosition += 10;
                    }
                    
                    // رسم إطار للصورة
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setLineWidth(0.5);
                    pdf.rect(xPosition - 2, yPosition - 2, imgWidth + 4, imgHeight + 4);
                    
                    // حساب أبعاد الصورة مع الحفاظ على التناسب
                    const aspectRatio = img.width / img.height;
                    let finalWidth = imgWidth;
                    let finalHeight = imgHeight;
                    let xOffset = 0;
                    let yOffset = 0;
                    
                    if (aspectRatio > 1) {
                      // صورة أفقية
                      finalHeight = imgWidth / aspectRatio;
                      yOffset = (imgHeight - finalHeight) / 2;
                    } else {
                      // صورة رأسية
                      finalWidth = imgHeight * aspectRatio;
                      xOffset = (imgWidth - finalWidth) / 2;
                    }
                    
                    // إضافة الصورة في وسط الإطار
                    pdf.addImage(img, 'JPEG', xPosition + xOffset, yPosition + yOffset, finalWidth, finalHeight);
                    
                    // نص تحت الصورة
                    pdf.setFontSize(9);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text(prepareArabicText(`شاهد ${i + 1}`), xPosition + imgWidth / 2, yPosition + imgHeight + 8, { align: 'center' });
                    
                    // إذا كانت هذه الصورة الثالثة في الصف، ننتقل للسطر التالي
                    if (i % 3 === 2) {
                      yPosition += imgHeight + 25;
                    }
                    
                    resolve();
                  };
                  
                  img.onerror = () => {
                    console.log('فشل تحميل الصورة:', session.witness[i].name);
                    resolve();
                  };
                });
              }
              
              // إذا لم تكن الصور من مضاعفات 3، ننتقل للسطر التالي
              if (session.witness.length % 3 !== 0) {
                yPosition += 70 + 25;
              }
              
              yPosition += 10;
            }
          }
          
          // حفظ الملف
          pdf.save('sessions_report.pdf');
          showToast('تم التصدير بنجاح');
        }catch(err){
          console.error('خطأ في التصدير:',err);
          showToast('حدث خطأ أثناء التصدير','err');
        }
      });
    }

    // ============== التقويم الهجري ==============
    function initializeHijriCalendar(){
      document.querySelectorAll('.date-with-hijri').forEach(wrapper=>{
        const input = wrapper.querySelector('.hijri-date-input');
        const calendar = wrapper.querySelector('.hijri-calendar');
        const toggleBtn = wrapper.querySelector('.hijri-toggle');
        const closeBtn = calendar.querySelector('#closeCalendar');
        const todayBtn = calendar.querySelector('.today-btn');
        const prevMonthBtn = calendar.querySelector('.prev-month');
        const nextMonthBtn = calendar.querySelector('.next-month');
        const prevYearBtn = calendar.querySelector('.prev-year');
        const nextYearBtn = calendar.querySelector('.next-year');
        const monthYearEl = calendar.querySelector('.hijri-month-year');
        const daysContainer = calendar.querySelector('.hijri-days');
        
        // حالة التقويم الحالية
        let currentGregorianDate = new Date();
        let currentHijri = gregorianToHijri(currentGregorianDate);

        function openCalendar(){
          document.querySelectorAll('.hijri-calendar').forEach(c=>c.classList.remove('active'));
          calendar.classList.add('active');
          renderCalendar();
        }

        function closeCalendar(){
          calendar.classList.remove('active');
        }

        function renderCalendar(){
          // عرض الشهر والسنة الهجرية
          monthYearEl.textContent = `${HIJRI_MONTHS[currentHijri.month-1]} ${currentHijri.year} هـ`;
          
          daysContainer.innerHTML = '';
          
          // حساب أول يوم في الشهر الهجري
          const firstDayGregorian = hijriToGregorian(1, currentHijri.month, currentHijri.year);
          const startDayOfWeek = firstDayGregorian.getDay();
          
          // إضافة أيام فارغة
          for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'hijri-day disabled';
            daysContainer.appendChild(emptyDay);
          }
          
          // حساب عدد أيام الشهر الهجري (29 أو 30)
          const daysInMonth = currentHijri.month % 2 === 1 ? 30 : 29;
          
          // إضافة أيام الشهر
          for (let i = 1; i <= daysInMonth; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'hijri-day';
            dayElement.textContent = i;
            
            // التحقق من اليوم الحالي
            const dayGregorian = hijriToGregorian(i, currentHijri.month, currentHijri.year);
            const today = new Date();
            
            if (dayGregorian.toDateString() === today.toDateString()) {
              dayElement.classList.add('today');
            }
            
            // التحقق من اليوم المختار
            if (input.value) {
              const parts = input.value.split(' ');
              const selectedDay = parseInt(parts[0]);
              const selectedMonth = HIJRI_MONTHS.indexOf(parts[1]) + 1;
              const selectedYear = parseInt(parts[2]);
              
              if (i === selectedDay && currentHijri.month === selectedMonth && currentHijri.year === selectedYear) {
                dayElement.classList.add('selected');
              }
            }
            
            dayElement.addEventListener('click', () => {
              input.value = `${i} ${HIJRI_MONTHS[currentHijri.month-1]} ${currentHijri.year} هـ`;
              closeCalendar();
            });
            
            daysContainer.appendChild(dayElement);
          }
        }

        // أحداث الأزرار
        toggleBtn.addEventListener('click', openCalendar);
        closeBtn.addEventListener('click', closeCalendar);
        
        // الانتقال إلى اليوم
        todayBtn.addEventListener('click', () => {
          currentGregorianDate = new Date();
          currentHijri = gregorianToHijri(currentGregorianDate);
          input.value = `${currentHijri.day} ${HIJRI_MONTHS[currentHijri.month-1]} ${currentHijri.year} هـ`;
          renderCalendar();
        });

        // التنقل بين الأشهر
        prevMonthBtn.addEventListener('click', () => {
          currentHijri.month--;
          if (currentHijri.month < 1) {
            currentHijri.month = 12;
            currentHijri.year--;
          }
          renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
          currentHijri.month++;
          if (currentHijri.month > 12) {
            currentHijri.month = 1;
            currentHijri.year++;
          }
          renderCalendar();
        });

        // التنقل بين السنوات
        prevYearBtn.addEventListener('click', () => {
          currentHijri.year--;
          renderCalendar();
        });

        nextYearBtn.addEventListener('click', () => {
          currentHijri.year++;
          renderCalendar();
        });

        // إغلاق التقويم عند النقر خارجها
        document.addEventListener('click', (e) => {
          if (calendar.classList.contains('active') && !wrapper.contains(e.target) && !calendar.contains(e.target)) {
            closeCalendar();
          }
        });
        
        // تهيئة التقويم بالتاريخ الحالي
        if (!input.value) {
          input.value = `${currentHijri.day} ${HIJRI_MONTHS[currentHijri.month-1]} ${currentHijri.year} هـ`;
        }
      });
    }
  </script>
</body>
</html>
