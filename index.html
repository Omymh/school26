<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="المدرسة السادسة والعشرون بتبوك - نظام تقارير الأنشطة والحصص">
  <title>المدرسة السادسة والعشرون - تبوك</title>
  <!-- مكتبات PDF ولقطة الشاشة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NaW7C+2yTQY+0o2iY9v3aHe9d5kzjzU3rjS9C8xH6l5nqfna3yX9tHfA3bQWq1JrZpJ/9v8Q4QdXKq7b0Q5xNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5H2qS8KjYyJp0hJr3eH8D9m1QjQ5j3oH8m2p9Dg9q8Qkq1z8X7UoIRc9mF3B8p9QhQxw1J1c9Z7eYb7F8bA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-green:#2E7D32; --secondary-green:#388E3C; --light-green:#4CAF50; --dark-green:#1B5E20; --accent-gold:#FFB300;
    }
    body{
      font-family:'Segoe UI','Arial',sans-serif; background:linear-gradient(135deg,var(--primary-green) 0%, var(--secondary-green) 100%);
      min-height:100vh; line-height:1.6; padding-bottom:120px;
    }
    /* Header Logo - ثابت بالتصفح فقط */
    .header-logo{background:#fff;padding:15px 20px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.15);position:sticky;top:0;z-index:1000}
    .logo-container{max-width:1200px;margin:0 auto}
    .logo-img{width:100%;max-width:780px;height:auto;max-height:110px;object-fit:contain;display:inline-block}
    /* Navigation */
    nav{background:rgba(255,255,255,.98);padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
    .nav-btn{padding:13px 35px;background:linear-gradient(135deg,var(--primary-green),var(--secondary-green));color:#fff;border:0;border-radius:30px;cursor:pointer;font-size:17px;font-weight:700;transition:.3s;box-shadow:0 3px 10px rgba(46,125,50,.3)}
    .nav-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(46,125,50,.5);background:linear-gradient(135deg,var(--secondary-green),var(--light-green))}
    .nav-btn.active{background:linear-gradient(135deg,var(--dark-green),var(--primary-green));box-shadow:0 4px 15px rgba(27,94,32,.6)}
    /* Container & Pages */
    .container{max-width:1200px;margin:30px auto;padding:0 20px}
    .page{display:none;background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.3);margin-bottom:30px}
    .page.active{display:block;animation:fadeIn .4s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    h1{color:var(--primary-green);text-align:center;margin-bottom:30px;font-size:36px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    h2{color:var(--primary-green);margin:30px 0 20px;font-size:26px;border-right:5px solid var(--accent-gold);padding-right:15px}
    /* Forms */
    .form-group{margin-bottom:22px}
    label{display:block;margin-bottom:8px;color:#2c3e50;font-weight:600;font-size:16px}
    input[type="text"],input[type="date"],input[type="number"],textarea,select{width:100%;padding:14px 16px;border:2px solid #ddd;border-radius:10px;font-size:16px;background:#fafafa;transition:.3s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary-green);background:#fff;box-shadow:0 0 0 4px rgba(46,125,50,.1)}
    textarea{min-height:110px;resize:vertical;line-height:1.6}
    /* Buttons */
    .btn{padding:15px 40px;background:linear-gradient(135deg,var(--primary-green),var(--secondary-green));color:#fff;border:none;border-radius:30px;cursor:pointer;font-size:17px;font-weight:700;transition:.3s;margin:10px 5px;box-shadow:0 4px 12px rgba(46,125,50,.3)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(46,125,50,.5)}
    .btn:active{transform:translateY(0)}
    .btn-secondary{background:linear-gradient(135deg,#00796B,#00897B)}
    .btn-danger{background:linear-gradient(135deg,#D32F2F,#C62828)}
    /* Image Upload */
    .image-upload{border:3px dashed var(--primary-green);padding:45px;text-align:center;border-radius:15px;cursor:pointer;transition:.3s;background:#f1f8f4}
    .image-upload:hover{background:#e8f5e9;border-color:var(--light-green);transform:scale(1.02)}
    .image-upload p{color:var(--primary-green);font-size:18px;font-weight:600}
    .preview-images{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;margin-top:25px}
    .preview-image{width:100%;height:180px;object-fit:cover;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.15);transition:transform .3s;border:3px solid var(--light-green)}
    .preview-image:hover{transform:scale(1.08)}
    /* Tables */
    table{width:100%;border-collapse:collapse;margin:30px 0;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.1);border-radius:12px;overflow:hidden}
    th,td{padding:16px 14px;text-align:center;border:1px solid #e0e0e0;font-size:15px}
    th{background:linear-gradient(135deg,var(--primary-green),var(--secondary-green));color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    tbody tr{transition:.2s} tbody tr:nth-child(even){background:#f8f9fa} tbody tr:hover{background:#e8f5e9;transform:scale(1.01)}
    /* Home */
    .home-content{text-align:center;padding:60px 20px}
    .home-content h1{font-size:48px;margin-bottom:20px;background:linear-gradient(135deg,var(--primary-green),var(--light-green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .home-content p{font-size:22px;color:#555;margin-bottom:20px}
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:35px;margin-top:60px}
    .feature-card{background:linear-gradient(135deg,var(--primary-green),var(--secondary-green));padding:40px;border-radius:20px;color:#fff;text-align:center;transition:.3s;box-shadow:0 6px 25px rgba(46,125,50,.3)}
    .feature-card:hover{transform:translateY(-15px);box-shadow:0 12px 35px rgba(46,125,50,.5)}
    .feature-card h3{font-size:28px;margin-bottom:18px}
    .feature-card p{font-size:17px;line-height:1.8}
    /* Checkbox group */
    .checkbox-group{display:flex;gap:25px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .checkbox-item{display:flex;align-items:center;gap:12px;padding:10px 18px;background:#f1f8f4;border-radius:10px;transition:.2s;border:2px solid transparent}
    .checkbox-item:hover{background:#e8f5e9;border-color:var(--light-green)}
    .checkbox-item input[type=checkbox]{width:22px;height:22px;cursor:pointer;accent-color:var(--primary-green)}
    .checkbox-item label{margin:0;cursor:pointer;font-weight:500}
    /* Action box */
    .action-buttons{text-align:center;margin:35px 0;padding:25px;background:linear-gradient(135deg,#f1f8f4,#e8f5e9);border-radius:15px}
    /* Report preview */
    .report-preview{background:#fff;padding:50px;border-radius:15px;margin-top:35px;border:3px solid var(--light-green);box-shadow:0 8px 30px rgba(46,125,50,.2)}
    .pdf-header{text-align:center;margin-bottom:40px;padding:30px;background:linear-gradient(135deg,#f1f8f4,#e8f5e9);border-radius:15px}
    .pdf-title{font-size:38px;color:var(--primary-green);font-weight:700;margin-bottom:12px;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .pdf-subtitle{font-size:20px;color:#555;margin-top:10px}
    .report-section{margin:30px 0;padding:25px;background:#f8f9fa;border-radius:12px;border-right:5px solid var(--accent-gold)}
    .report-section h3{color:var(--primary-green);font-size:24px;margin-bottom:15px}
    /* Footer (لا يُطبع) */
    .site-footer{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,var(--primary-green),var(--dark-green));color:#fff;padding:20px;text-align:center;box-shadow:0 -4px 15px rgba(0,0,0,.2);z-index:999}
    .site-footer p{margin:5px 0;font-size:15px}
    .delete-btn{padding:10px 18px;background:linear-gradient(135deg,#D32F2F,#C62828);color:#fff;border:0;border-radius:20px;cursor:pointer;font-size:14px;font-weight:700;transition:.3s}
    .delete-btn:hover{transform:scale(1.08);box-shadow:0 4px 12px rgba(211,47,47,.5)}
    /* Print */
    @media print{
      body{background:#fff;padding-bottom:0}
      nav,.btn,.form-group,.image-upload,.action-buttons,.site-footer{display:none !important}
      .page{box-shadow:none;padding:20px}
      .header-logo{position:static;box-shadow:none;page-break-after:avoid}
      table{page-break-inside:auto}
      tr{page-break-inside:avoid;page-break-after:auto}
      thead{display:table-header-group}
      .no-print{display:none !important}
      .report-preview{border:none;box-shadow:none}
    }
    /* Responsive */
    @media (max-width:768px){
      .container{padding:0 15px}
      .page{padding:25px 20px}
      h1{font-size:28px}
      .home-content h1{font-size:32px}
      .nav-btn{padding:11px 25px;font-size:15px}
      table{font-size:13px} th,td{padding:10px 8px}
      .features{grid-template-columns:1fr}
      .preview-images{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
      .site-footer{padding:15px 10px}
      .site-footer p{font-size:13px}
      .report-preview{padding:25px 15px}
      .pdf-header{padding:20px}
      .pdf-title{font-size:26px}
    }
    @media (max-width:480px){
      h1{font-size:24px}
      .checkbox-group{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <!-- Header Logo (يقرأ الصورة 26.png من الجذر) -->
  <div class="header-logo">
    <div class="logo-container">
      <img src="26.png" class="logo-img" alt="ديباجة المدرسة السادسة والعشرون - تبوك" onerror="this.insertAdjacentHTML('afterend','<div style=&quot;color:#b91c1c;margin:.5rem 0&quot;>⚠️ ارفع صورة الديباجة باسم <b>26.png</b> في نفس مجلد <b>index.html</b>.</div>'); this.remove();">
    </div>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <button class="nav-btn active" onclick="showPage('home', event)">🏠 الصفحة الرئيسية</button>
      <button class="nav-btn" onclick="showPage('activities', event)">📊 تقارير الأنشطة</button>
      <button class="nav-btn" onclick="showPage('sessions', event)">📝 تقارير الحصص</button>
    </div>
  </nav>

  <div class="container">
    <!-- الصفحة الرئيسية -->
    <div id="home" class="page active">
      <div class="home-content">
        <h1>🌟 نظام التقارير المدرسية</h1>
        <p><strong>المدرسة السادسة والعشرون - تبوك</strong></p>
        <p>توثيق الأنشطة والحصص المدرسية بتنسيق احترافي وتصدير PDF</p>
        <div class="features">
          <div class="feature-card"><h3>📊 تقارير الأنشطة</h3><p>رفع الصور والشواهد وتصدير PDF</p></div>
          <div class="feature-card"><h3>📝 تقارير الحصص</h3><p>حفظ وعرض حصص الانتظار وجدول منظم</p></div>
          <div class="feature-card"><h3>📄 طباعة وتقارير</h3><p>التقارير تطبع بدون تذليل الموقع</p></div>
        </div>
      </div>
    </div>

    <!-- صفحة تقارير الأنشطة -->
    <div id="activities" class="page">
      <h1>📊 تقرير النشاط المدرسي</h1>
      <div class="form-group"><label>📝 اسم البرنامج / النشاط: *</label><input class="input" type="text" id="activityName" placeholder="أدخل اسم البرنامج أو النشاط"></div>
      <div class="form-group"><label>👤 المنفذ: *</label><input class="input" type="text" id="executor" placeholder="اسم المنفذ"></div>
      <div class="form-group"><label>👥 عدد المستفيدين:</label><input class="input" type="number" id="beneficiaries" placeholder="عدد المستفيدين" min="1"></div>
      <div class="form-group"><label>📅 التاريخ: *</label><input class="input" type="date" id="activityDate"></div>
      <div class="form-group"><label>📍 المكان:</label><input class="input" type="text" id="location" placeholder="مكان تنفيذ النشاط"></div>
      <div class="form-group"><label>🎯 الأهداف:</label><textarea class="input" id="objectives" placeholder="أهداف النشاط..."></textarea></div>
      <div class="form-group"><label>📋 وصف النشاط:</label><textarea class="input" id="description" placeholder="وصف تفصيلي للنشاط المنفذ..."></textarea></div>
      <div class="form-group">
        <label>📷 رفع صور الشواهد:</label>
        <div class="image-upload" onclick="document.getElementById('activityImages').click()">
          <p>📷 اضغط هنا لرفع الصور</p>
          <input type="file" id="activityImages" multiple accept="image/*" style="display:none" onchange="previewActivityImages(event)">
        </div>
        <div class="preview-images" id="activityPreview"></div>
      </div>
      <div class="action-buttons">
        <button class="btn" onclick="generateActivityReport()">👁️ معاينة التقرير</button>
        <button class="btn btn-secondary" onclick="exportActivityPDF()">📥 تصدير PDF</button>
      </div>
      <div id="activityReport" class="report-preview" style="display:none;"></div>
    </div>

    <!-- صفحة تقارير الحصص -->
    <div id="sessions" class="page">
      <h1>📝 تقرير حصص الانتظار</h1>
      <h2>📝 إدخال بيانات الحصة</h2>
      <div class="form-group"><label>📅 اليوم: *</label>
        <select class="input" id="dayName"><option value="">اختر اليوم</option><option value="الأحد">الأحد</option><option value="الاثنين">الاثنين</option><option value="الثلاثاء">الثلاثاء</option><option value="الأربعاء">الأربعاء</option><option value="الخميس">الخميس</option></select>
      </div>
      <div class="form-group"><label>📆 التاريخ: *</label><input class="input" type="date" id="sessionDate"></div>
      <div class="form-group"><label>🏫 الصف: *</label><input class="input" type="text" id="className" placeholder="مثال: الثالث الابتدائي"></div>
      <div class="form-group"><label>🔢 رقم الحصة: *</label><input class="input" type="number" id="sessionNumber" placeholder="رقم الحصة" min="1" max="10"></div>
      <div class="form-group"><label>👩‍🏫 اسم المعلمة الغائبة: *</label><input class="input" type="text" id="absentTeacher" placeholder="اسم المعلمة"></div>
      <div class="form-group"><label>✍️ ما تم تنفيذه: *</label><textarea class="input" id="activitiesText" placeholder="اكتب الأنشطة المنفذة بالتفصيل..."></textarea></div>
      <div class="form-group"><label>🎯 المجال: *</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="basicSkills" value="المهارات الأساسية"><label for="basicSkills">المهارات الأساسية</label></div>
          <div class="checkbox-item"><input type="checkbox" id="values" value="القيم والمواطنة الصالحة"><label for="values">القيم والمواطنة الصالحة</label></div>
          <div class="checkbox-item"><input type="checkbox" id="futureSkills" value="مهارات المستقبل"><label for="futureSkills">مهارات المستقبل</label></div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn" onclick="addSession()">💾 حفظ الحصة</button>
        <button class="btn btn-secondary" onclick="exportSessionsPDF()">📥 تصدير PDF</button>
        <button class="btn btn-danger" onclick="clearAllSessions()">🗑️ مسح الكل</button>
      </div>
      <div class="session-table-container" id="sessionsTableContainer" style="display:none;">
        <h2 style="text-align:center;">📋 الحصص المسجلة</h2>
        <table id="sessionsTable">
          <thead>
            <tr>
              <th style="width:50px;">م</th><th style="width:80px;">اليوم</th><th style="width:110px;">التاريخ</th><th style="width:140px;">الصف</th>
              <th style="width:70px;">الحصة</th><th style="width:140px;">المعلمة الغائبة</th><th style="min-width:220px;">ما تم تنفيذه</th><th style="min-width:170px;">المجال</th><th style="width:90px;" class="no-print">إجراءات</th>
            </tr>
          </thead>
          <tbody id="sessionsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer ثابت - لا يطبع -->
  <footer class="site-footer">
    <p><strong>🏫 مديرة المدرسة:</strong> أماني آل عبشان</p>
    <p><strong>🎨 تصميم الهيئة الإدارية:</strong> عيدة صلاح، منيرة العمراني</p>
  </footer>

  <script>
    // ===== Utilities =====
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const storage = {
      get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    };

    // ===== Navigation =====
    function showPage(pageId, ev){
      $$('.page').forEach(p=>p.classList.remove('active'));
      $$('.nav-btn').forEach(b=>b.classList.remove('active'));
      $('#'+pageId).classList.add('active');
      if (ev && ev.target) ev.target.classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ===== Activities (Report) =====
    let activityImages = [];
    function previewActivityImages(e){
      const files = e.target.files; const preview = $('#activityPreview');
      preview.innerHTML=''; activityImages=[];
      if (!files.length) return;
      Array.from(files).forEach(file=>{
        if (!file.type.startsWith('image/')){ alert('⚠️ الرجاء اختيار صور فقط'); return; }
        const reader = new FileReader();
        reader.onload = function(evt){
          activityImages.push(evt.target.result);
          const img = new Image(); img.src = evt.target.result; img.className='preview-image'; img.alt='صورة شاهد';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    function formatDate(val){
      try{ return new Date(val).toLocaleDateString('ar-SA',{year:'numeric',month:'long',day:'numeric'}); }catch{ return val||''; }
    }

    function generateActivityReport(){
      const report = $('#activityReport');
      const name = $('#activityName').value.trim();
      const executor = $('#executor').value.trim();
      const beneficiaries = $('#beneficiaries').value.trim();
      const date = $('#activityDate').value;
      const location = $('#location').value.trim();
      const objectives = $('#objectives').value.trim();
      const description = $('#description').value.trim();
      if (!name || !executor || !date){ alert('⚠️ الرجاء تعبئة الحقول الأساسية المطلوبة (*)'); return; }

      let html = `
        <div class="pdf-header">
          <img src="26.png" alt="ديباجة" style="max-height:110px;object-fit:contain;display:block;margin:0 auto 10px">
          <h2 class="pdf-title">📊 تقرير النشاط المدرسي</h2>
          <p class="pdf-subtitle">المدرسة السادسة والعشرون - تبوك</p>
          <p style="color:#888;margin-top:10px;font-size:16px;">📅 تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA',{year:'numeric',month:'long',day:'numeric'})}</p>
        </div>
        <div class="report-section">
          <h3>📋 بيانات النشاط</h3>
          <table style="margin:20px 0;">
            <tbody>
              <tr><td style="background:linear-gradient(135deg,#f1f8f4,#e8f5e9);font-weight:700;width:30%;text-align:right;">📝 اسم البرنامج</td><td style="text-align:right;padding:15px;font-size:16px;">${name}</td></tr>
              <tr><td style="background:linear-gradient(135deg,#f1f8f4,#e8f5e9);font-weight:700;text-align:right;">👤 المنفذ</td><td style="text-align:right;padding:15px;font-size:16px;">${executor}</td></tr>
              <tr><td style="background:linear-gradient(135deg,#f1f8f4,#e8f5e9);font-weight:700;text-align:right;">👥 عدد المستفيدين</td><td style="text-align:right;padding:15px;font-size:16px;">${beneficiaries||'غير محدد'}</td></tr>
              <tr><td style="background:linear-gradient(135deg,#f1f8f4,#e8f5e9);font-weight:700;text-align:right;">📅 التاريخ</td><td style="text-align:right;padding:15px;font-size:16px;">${formatDate(date)}</td></tr>
              <tr><td style="background:linear-gradient(135deg,#f1f8f4,#e8f5e9);font-weight:700;text-align:right;">📍 المكان</td><td style="text-align:right;padding:15px;font-size:16px;">${location||'غير محدد'}</td></tr>
            </tbody>
          </table>
        </div>
        ${objectives?`<div class="report-section"><h3>🎯 الأهداف</h3><p style="text-align:right;line-height:2;padding:15px;background:#fff;border-radius:8px;font-size:16px;">${objectives}</p></div>`:''}
        ${description?`<div class="report-section"><h3>📋 وصف النشاط</h3><p style="text-align:right;line-height:2;padding:15px;background:#fff;border-radius:8px;font-size:16px;">${description}</p></div>`:''}
      `;
      if (activityImages.length){
        html += `<div class="report-section"><h3 style="text-align:center;font-size:26px;margin-bottom:25px;">📷 صور الشواهد</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:25px;margin-top:25px;">`;
        activityImages.forEach((img,i)=>{
          html += `<div style="text-align:center"><img src="${img}" style="width:100%;max-height:400px;object-fit:cover;border-radius:12px;box-shadow:0 6px 20px rgba(46,125,50,.3);border:4px solid #4CAF50"><p style="margin-top:12px;color:#2E7D32;font-weight:700;font-size:15px;">📸 شاهد ${i+1}</p></div>`;
        });
        html += `</div></div>`;
      }
      report.innerHTML = html;
      report.style.display='block';
      report.scrollIntoView({behavior:'smooth',block:'start'});
    }

    async function exportActivityPDF(){
      const report = $('#activityReport');
      if (report.style.display==='none' || !report.innerHTML.trim()){ alert('⚠️ الرجاء معاينة التقرير أولاً'); return; }
      const loadingMsg = document.createElement('div');
      loadingMsg.textContent='⏳ جاري تصدير PDF...';
      loadingMsg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#2E7D32;color:#fff;padding:20px 40px;border-radius:10px;font-size:18px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.3)';
      document.body.appendChild(loadingMsg);
      try{
        await new Promise(r=>setTimeout(r,300));
        const canvas = await html2canvas(report,{scale:2,useCORS:true,backgroundColor:'#ffffff',logging:false,windowWidth:1200});
        const imgData = canvas.toDataURL('image/jpeg',0.98);
        const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','mm','a4');
        const pageWidth = 210, pageHeight = 297, margin = 10, usable = pageHeight - margin*2;
        const imgWidth = pageWidth - margin*2;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight, position = margin;
        pdf.addImage(imgData,'JPEG',margin,position,imgWidth,imgHeight,'','FAST');
        heightLeft -= usable;
        while (heightLeft > 0){
          pdf.addPage();
          position = margin - (imgHeight - heightLeft);
          pdf.addImage(imgData,'JPEG',margin,position,imgWidth,imgHeight,'','FAST');
          heightLeft -= usable;
        }
        const activityName = ($('#activityName').value||'مدرسي').trim();
        pdf.save(`تقرير_نشاط_${activityName||'مدرسي'}.pdf`);
      }catch(err){ console.error(err); alert('❌ حدث خطأ أثناء التصدير'); }
      finally{ document.body.removeChild(loadingMsg); }
    }

    // ===== Sessions (Save & PDF) =====
    let sessions = storage.get('sessionsData', []);
    function addSession(){
      const day = $('#dayName').value;
      const date = $('#sessionDate').value;
      const className = $('#className').value.trim();
      const number = $('#sessionNumber').value;
      const teacher = $('#absentTeacher').value.trim();
      const acts = $('#activitiesText').value.trim();
      if (!day || !date || !className || !number || !teacher || !acts){ alert('⚠️ الرجاء تعبئة جميع الحقول المطلوبة'); return; }
      const fields = []; if($('#basicSkills').checked) fields.push('المهارات الأساسية');
      if($('#values').checked) fields.push('القيم والمواطنة الصالحة');
      if($('#futureSkills').checked) fields.push('مهارات المستقبل');
      if (!fields.length){ alert('⚠️ الرجاء اختيار مجال واحد على الأقل'); return; }
      sessions.push({day,date,className,number,teacher,activities:acts,fields:fields.join('، ')});
      storage.set('sessionsData', sessions);
      displaySessions(); clearSessionForm(); alert('✅ تم حفظ الحصة بنجاح!');
    }

    function displaySessions(){
      const container = $('#sessionsTableContainer');
      const tbody = $('#sessionsTableBody');
      if (!sessions.length){ container.style.display='none'; tbody.innerHTML=''; return; }
      container.style.display='block'; tbody.innerHTML='';
      sessions.forEach((s,i)=>{
        const row = tbody.insertRow();
        row.innerHTML = `
          <td><strong>${i+1}</strong></td>
          <td>${s.day}</td>
          <td>${formatDate(s.date)}</td>
          <td>${s.className}</td>
          <td>${s.number}</td>
          <td>${s.teacher}</td>
          <td style="text-align:right;padding:14px;">${s.activities}</td>
          <td style="text-align:right;padding:14px;">${s.fields}</td>
          <td class="no-print"><button class="delete-btn" onclick="deleteSession(${i})">🗑️</button></td>`;
      });
    }

    function deleteSession(i){
      if(confirm('هل أنت متأكد من حذف هذه الحصة؟')){
        sessions.splice(i,1);
        storage.set('sessionsData', sessions);
        displaySessions(); alert('✅ تم الحذف');
      }
    }
    function clearAllSessions(){
      if(!sessions.length){alert('⚠️ لا توجد حصص');return;}
      if(confirm('⚠️ حذف جميع الحصص؟')){ sessions=[]; storage.set('sessionsData', sessions); displaySessions(); alert('✅ تم الحذف'); }
    }
    function clearSessionForm(){
      ['dayName','sessionDate','className','sessionNumber','absentTeacher','activitiesText'].forEach(id=>$('#'+id).value='');
      ['basicSkills','values','futureSkills'].forEach(id=>$('#'+id).checked=false);
    }

    async function exportSessionsPDF(){
      if (!sessions.length){ alert('⚠️ لا توجد حصص لتصديرها'); return; }
      const loadingMsg = document.createElement('div');
      loadingMsg.textContent='⏳ جاري تصدير PDF...';
      loadingMsg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#2E7D32;color:#fff;padding:20px 40px;border-radius:10px;font-size:18px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.3)';
      document.body.appendChild(loadingMsg);
      try{
        // منطقة طباعة مخصصة (بدون تذليل)
        const wrap = document.createElement('div');
        wrap.style.cssText='padding:40px;background:#fff;font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;';
        wrap.innerHTML = `
          <div style="text-align:center;margin-bottom:20px;padding:16px;background:linear-gradient(135deg,#f1f8f4,#e8f5e9);border-radius:12px;border:3px solid #4CAF50;">
            <img src="26.png" alt="ديباجة" style="max-height:110px;object-fit:contain;display:block;margin:0 auto 10px">
            <h1 style="color:#2E7D32;font-size:28px;margin:10px 0 0;">📝 تقرير حصص الانتظار</h1>
            <p style="color:#666;font-size:16px;margin:8px 0;"><strong>المدرسة السادسة والعشرون - تبوك</strong></p>
            <p style="color:#888;margin-top:6px;font-size:14px;">📅 تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
          </div>
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:linear-gradient(135deg,#2E7D32,#388E3C);color:#fff">
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">م</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">اليوم</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">التاريخ</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">الصف</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">الحصة</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">المعلمة الغائبة</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">ما تم تنفيذه</th>
                <th style="border:2px solid #fff;padding:10px;font-size:13px;">المجال</th>
              </tr>
            </thead>
            <tbody>
              ${sessions.map((s,i)=>`
                <tr>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${i+1}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${s.day}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${formatDate(s.date)}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${s.className}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${s.number}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:center">${s.teacher}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:right">${s.activities}</td>
                  <td style="border:1px solid #e0e0e0;padding:8px;text-align:right">${s.fields}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
        document.body.appendChild(wrap);
        await new Promise(r=>setTimeout(r,250));
        const canvas = await html2canvas(wrap,{scale:2,useCORS:true,backgroundColor:'#ffffff',logging:false,windowWidth:1200});
        const imgData = canvas.toDataURL('image/jpeg',0.98);
        const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','mm','a4');
        const pageWidth = 210, pageHeight = 297, margin = 10, usable = pageHeight - margin*2;
        const imgWidth = pageWidth - margin*2;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight, position = margin;
        pdf.addImage(imgData,'JPEG',margin,position,imgWidth,imgHeight,'','FAST');
        heightLeft -= usable;
        while (heightLeft > 0){
          pdf.addPage();
          position = margin - (imgHeight - heightLeft);
          pdf.addImage(imgData,'JPEG',margin,position,imgWidth,imgHeight,'','FAST');
          heightLeft -= usable;
        }
        pdf.save('تقرير_حصص_الانتظار.pdf');
        document.body.removeChild(wrap);
      }catch(err){ console.error(err); alert('❌ حدث خطأ أثناء التصدير'); }
      finally{ document.body.removeChild(loadingMsg); }
    }

    // Init
    displaySessions();
  </script>
</body>
</html>
