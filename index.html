<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>المدرسة السادسة والعشرون - تبوك</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap');
    :root {
      --primary: #10b981;
      --secondary: #059669;
      --dark: #047857;
      --light: #d1fae5;
      --accent: #fbbf24;
      --container: max(280px, min(1200px, 94vw));
      --print-width: 180mm;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%);
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
      line-height: 1.7;
      color: #0f172a;
      min-height: 100vh;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, .05) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(5, 150, 105, .05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .header-logo {
      background: linear-gradient(180deg, #fff 0%, #f9fafb 100%);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(16, 185, 129, .1);
      border-bottom: 2px solid var(--light);
    }
    
    .header-logo .wrap {
      width: var(--container);
      margin: auto;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-logo img {
      width: 100%;
      max-height: 100px;
      object-fit: contain;
      display: block;
      margin: auto;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, .1));
    }
    
    nav {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      box-shadow: 0 4px 20px rgba(16, 185, 129, .2);
    }
    
    .nav {
      width: var(--container);
      margin: auto;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      padding: 16px;
    }
    
    .nav-btn {
      border: none;
      border-radius: 25px;
      padding: 12px 28px;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
      transition: all .3s;
      font-size: 15px;
    }
    
    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, .15);
    }
    
    .nav-btn.active {
      background: linear-gradient(135deg, var(--dark), var(--primary));
      color: #fff;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(4, 120, 87, .4);
    }
    
    .container {
      width: var(--container);
      margin: auto;
      padding: 24px 24px 120px;
      position: relative;
      z-index: 1;
    }
    
    .page {
      display: none;
      background: #fff;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(16, 185, 129, .1);
      margin-bottom: 24px;
    }
    
    .page.active {
      display: block;
      animation: slideIn .4s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h1 {
      color: transparent;
      background: linear-gradient(135deg, var(--primary), var(--dark));
      -webkit-background-clip: text;
      background-clip: text;
      text-align: center;
      margin: 0 0 20px;
      font-size: 32px;
      font-weight: 900;
    }
    
    h2 {
      color: var(--primary);
      margin: 24px 0 12px;
      font-size: 22px;
      border-right: 6px solid var(--accent);
      padding-right: 12px;
      font-weight: 800;
    }
    
    .page p {
      text-align: center;
      font-size: 18px;
      color: #64748b;
      margin: 20px auto;
      max-width: 800px;
      line-height: 1.8;
    }
    
    .form {
      display: grid;
      gap: 16px;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    label {
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: #334155;
      font-weight: 600;
      font-size: 15px;
    }
    
    .chipset {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid var(--light);
      cursor: pointer;
      transition: all .3s;
    }
    
    .chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, .2);
    }
    
    .chip input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    
    .input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      font-size: 16px;
      transition: all .3s;
    }
    
    .input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, .1);
    }
    
    textarea {
      min-height: 110px;
      resize: vertical;
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 20px;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 6px 20px rgba(16, 185, 129, .3);
      transition: all .2s;
      font-size: 15px;
      display: inline-block;
      text-align: center;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, .4);
    }
    
    .btn.danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .upload {
      border: 3px dashed var(--primary);
      border-radius: 16px;
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all .3s;
    }
    
    .upload:hover {
      background: linear-gradient(135deg, #dcfce7, #d1fae5);
    }
    
    .upload p {
      color: var(--primary);
      font-weight: 800;
      margin: 0 0 10px;
      font-size: 15px;
    }
    
    .witness-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    
    .witness-grid img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 12px;
      border: 3px solid var(--light);
      box-shadow: 0 8px 20px rgba(0, 0, 0, .1);
    }
    
    .hint {
      text-align: center;
      color: var(--secondary);
      font-weight: 600;
      margin-top: 10px;
      font-size: 14px;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .08);
      margin: 16px 0;
    }
    
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      font-weight: 800;
      font-size: 13px;
    }
    
    tbody tr:hover {
      background: #f0fdf4;
    }
    
    tbody tr:nth-child(even) {
      background: #f8fafc;
    }
    
    .table-wrap {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .05);
    }
    
    .site-footer {
      position: fixed;
      inset: auto 0 0 0;
      background: linear-gradient(135deg, var(--primary), var(--dark));
      color: #fff;
      padding: 12px;
      text-align: center;
      box-shadow: 0 -8px 30px rgba(0, 0, 0, .15);
      z-index: 5;
    }
    
    .site-footer p {
      margin: 5px 0;
      font-size: 14px;
    }
    
    .site-footer strong {
      color: var(--accent);
    }
    
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 12px 20px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .2);
      z-index: 9999;
      font-size: 15px;
      font-weight: 700;
      animation: toastIn .3s ease;
    }
    
    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    .toast.err {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .toast.warn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .print-doc {
      display: none;
    }
    
    .print-wrap {
      width: var(--print-width);
      margin: 0 auto;
    }
    
    .print-header-edge {
      width: 210mm;
      margin-left: calc((210mm - var(--print-width)) / -2);
      margin-right: calc((210mm - var(--print-width)) / -2);
      margin-bottom: 6mm;
    }
    
    .print-header-edge img {
      width: 210mm;
      height: auto;
      display: block;
    }
    
    .print-title {
      font-size: 19pt;
      color: #0b3d3a;
      font-weight: 800;
      margin: 2mm 0;
      text-align: center;
    }
    
    .print-sub {
      font-size: 11pt;
      color: #000;
      margin-bottom: 2mm;
      text-align: center;
    }
    
    .boxes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3mm;
      margin-top: 2mm;
    }
    
    .box {
      border: 2px solid #000;
      border-radius: 6px;
      padding: 3mm;
    }
    
    .box .label {
      font-weight: 800;
      margin-bottom: 2mm;
    }
    
    .box .value {
      white-space: pre-wrap;
    }
    
    .witness-section {
      break-inside: avoid-page;
      page-break-inside: avoid;
    }
    
    .witness2x2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4mm;
    }
    
    .witness2x2 .slot {
      width: 100%;
      height: 88mm;
      border: 2px solid #000;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .witness2x2 .slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .print-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 3mm;
      table-layout: fixed;
    }
    
    .print-table th, .print-table td {
      border: 2px solid #000;
      padding: 2.2mm 1.8mm;
      font-size: 10pt;
      text-align: center;
    }
    
    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .witness-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .witness-grid img {
        height: 130px;
      }
    }
    
    @media (max-width: 480px) {
      :root {
        --container: 100vw;
      }
      .container {
        width: 100vw;
        padding: 16px 16px 120px;
      }
      .page {
        padding: 20px;
        border-radius: 16px;
      }
      h1 {
        font-size: 24px;
      }
      .nav {
        width: 100vw;
        padding: 12px;
        gap: 8px;
      }
      .nav-btn {
        flex: 1 1 auto;
        padding: 10px 12px;
        font-size: 13px;
      }
      .actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .btn {
        width: 100%;
        padding: 14px;
        font-size: 15px;
      }
      .witness-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      .witness-grid img {
        height: 120px;
      }
      .table-wrap {
        overflow-x: auto;
      }
      table {
        min-width: 760px;
        font-size: 13px;
      }
      .header-logo img {
        max-height: 70px;
      }
      .site-footer p {
        font-size: 12px;
      }
    }
    
    @media print {
      @page {
        size: A4;
        margin: 0;
      }
      header, nav, main, .site-footer, .toast, .no-print {
        display: none !important;
      }
      .print-doc {
        display: block !important;
      }
      .print-page {
        width: var(--print-width);
        margin: 0 auto;
        background: #fff;
      }
      .print-page, .print-page * {
        background: #fff !important;
        box-shadow: none !important;
      }
      .print-table thead th {
        background: #fff !important;
        color: #000 !important;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header class="header-logo">
    <div class="wrap"><img src="26.png" alt="ديباجة المدرسة"></div>
  </header>
  <nav>
    <div class="nav">
      <button class="nav-btn active" id="navHome">الصفحة الرئيسية</button>
      <button class="nav-btn" id="navActivities">تقارير الأنشطة</button>
      <button class="nav-btn" id="navSessions">تقارير الحصص</button>
    </div>
  </nav>
  <main class="container">
    <section id="home" class="page active">
      <h1>نظام التقارير المدرسية</h1>
      <p>مرحباً بالمعلمات الكريمات في منصة المدرسة السادسة والعشرون بتبوك لتوثيق الأنشطة والحصص بكفاءة وسهولة.</p>
    </section>
    <section id="activities" class="page">
      <h1>تقرير النشاط المدرسي</h1>
      <form id="actForm" class="form">
        <div class="grid-2">
          <label>اسم البرنامج / النشاط *<input class="input" name="title" required></label>
          <label>المنفذ *<input class="input" name="owner" required></label>
          <label>عدد المستفيدين<input class="input" name="count" type="number" min="1"></label>
          <label>التاريخ *<input class="input" type="date" name="date" required></label>
          <label>المكان<input class="input" name="place"></label>
        </div>
        <label>الأهداف<textarea class="input" name="goals"></textarea></label>
        <label>وصف النشاط<textarea class="input" name="desc"></textarea></label>
        <div>
          <div class="upload" id="uploadBox">
            <p>اضغطي هنا لرفع صور الشواهد (حد أقصى 4)</p>
            <input type="file" id="witnessFiles" accept="image/*" multiple hidden>
            <button class="btn" type="button" id="addWitness">إضافة الشواهد</button>
          </div>
          <div id="witnessPreview" class="witness-grid"></div>
          <div class="actions" style="margin-top:16px">
            <button class="btn" type="button" id="exportActivity">تصدير PDF</button>
            <button class="btn danger" type="button" id="clearWitness">حذف الصور</button>
          </div>
          <div class="hint" id="wCount">(0/4)</div>
        </div>
      </form>
    </section>
    <section id="sessions" class="page">
      <h1>تقرير حصص الانتظار</h1>
      <form id="sesForm" class="form">
        <label>اسم المعلمة<input class="input" id="reportTeacher" placeholder="اكتبي اسم المعلمة هنا"></label>
        <div class="grid-2">
          <label>اليوم *<select class="input" id="dayName" required>
            <option value="">اختر</option>
            <option>الأحد</option>
            <option>الاثنين</option>
            <option>الثلاثاء</option>
            <option>الأربعاء</option>
            <option>الخميس</option>
          </select></label>
          <label>التاريخ *<input class="input" type="date" id="sessionDate" required></label>
          <label>الصف *<input class="input" id="className" required></label>
          <label>رقم الحصة *<input class="input" type="number" id="sessionNumber" min="1" max="10" required></label>
          <label>المعلمة الغائبة *<input class="input" id="absentTeacher" required></label>
        </div>
        <label>ما تم تنفيذه *<textarea class="input" id="activitiesText" required></textarea></label>
        <div class="chipset">
          <label class="chip"><input type="checkbox" id="basicSkills"> المهارات الأساسية</label>
          <label class="chip"><input type="checkbox" id="values"> القيم والمواطنة الصالحة</label>
          <label class="chip"><input type="checkbox" id="futureSkills"> مهارات المستقبل</label>
        </div>
        <div class="actions">
          <button class="btn" type="button" id="saveSession">حفظ الحصة</button>
          <button class="btn" type="button" id="exportSessions">تصدير PDF</button>
          <button class="btn danger" type="button" id="clearAll">مسح الكل</button>
        </div>
      </form>
      <h2>الحصص المسجلة</h2>
      <div class="table-wrap">
        <table id="sessionsTable">
          <thead>
            <tr>
              <th style="width:50px">م</th>
              <th style="width:90px">اليوم</th>
              <th style="width:120px">التاريخ</th>
              <th>الصف</th>
              <th style="width:70px">الحصة</th>
              <th style="width:160px">المعلمة الغائبة</th>
              <th style="min-width:240px">ما تم تنفيذه</th>
              <th style="min-width:160px">المجال</th>
              <th class="no-print" style="width:90px">إجراء</th>
            </tr>
          </thead>
          <tbody id="sessionsBody"></tbody>
        </table>
      </div>
    </section>
  </main>
  <div id="printRoot" class="print-doc"></div>
  <footer class="site-footer">
    <p><strong>مديرة المدرسة:</strong> أماني آل عبشان</p>
    <p><strong>تصميم الهيئة الإدارية:</strong> عيدة صلاح، منيرة العمراني</p>
  </footer>
  <script>
    (function(){
      var witness = [];
      var sessions = [];
      try {
        var s = localStorage.getItem('sessionsData');
        if (s) sessions = JSON.parse(s);
      } catch(e) {}

      function toast(m, t) {
        var d = document.createElement('div');
        d.className = 'toast ' + (t || '');
        d.textContent = m;
        document.body.appendChild(d);
        setTimeout(function() {
          d.style.opacity = '0';
        }, 1400);
        setTimeout(function() {
          d.remove();
        }, 1900);
      }

      function fmt(v) {
        try {
          return new Date(v).toLocaleDateString('ar-SA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        } catch(e) {
          return v || '';
        }
      }

      document.getElementById('navHome').onclick = function() {
        document.querySelectorAll('.page').forEach(function(p) {
          p.classList.remove('active');
        });
        document.querySelectorAll('.nav-btn').forEach(function(b) {
          b.classList.remove('active');
        });
        document.getElementById('home').classList.add('active');
        this.classList.add('active');
      };

      document.getElementById('navActivities').onclick = function() {
        document.querySelectorAll('.page').forEach(function(p) {
          p.classList.remove('active');
        });
        document.querySelectorAll('.nav-btn').forEach(function(b) {
          b.classList.remove('active');
        });
        document.getElementById('activities').classList.add('active');
        this.classList.add('active');
      };

      document.getElementById('navSessions').onclick = function() {
        document.querySelectorAll('.page').forEach(function(p) {
          p.classList.remove('active');
        });
        document.querySelectorAll('.nav-btn').forEach(function(b) {
          b.classList.remove('active');
        });
        document.getElementById('sessions').classList.add('active');
        this.classList.add('active');
      };

      var wInput = document.getElementById('witnessFiles');
      var wPrev = document.getElementById('witnessPreview');
      var wCount = document.getElementById('wCount');

      document.getElementById('uploadBox').onclick = function() {
        wInput.click();
      };

      document.getElementById('addWitness').onclick = function(e) {
        e.preventDefault();
        wInput.click();
      };

      wInput.onchange = function(e) {
        witness = [];
        wPrev.innerHTML = '';
        var files = [].slice.call(e.target.files || []).filter(function(f) {
          return f.type.indexOf('image/') === 0;
        }).slice(0, 4);
        
        (function loop(i) {
          if (i >= files.length) {
            wCount.textContent = '(' + witness.length + '/4)';
            toast('تم تحميل الشواهد');
            return;
          }
          var fr = new FileReader();
          fr.onload = function() {
            witness.push({
              name: files[i].name,
              url: fr.result
            });
            var im = document.createElement('img');
            im.src = fr.result;
            wPrev.appendChild(im);
            loop(i + 1);
          };
          fr.readAsDataURL(files[i]);
        })(0);
      };

      document.getElementById('clearWitness').onclick = function(e) {
        e.preventDefault();
        if (!witness.length) {
          toast('لا توجد صور', 'warn');
          return;
        }
        if (!confirm('حذف جميع صور الشواهد؟')) return;
        witness = [];
        wInput.value = '';
        wPrev.innerHTML = '';
        wCount.textContent = '(0/4)';
        toast('تم الحذف');
      };

      document.getElementById('exportActivity').onclick = function(e) {
        e.preventDefault();
        var form = document.getElementById('actForm');
        var data = {};
        var fd = new FormData(form);
        fd.forEach(function(v, k) {
          data[k] = v;
        });
        if (!data.title || !data.owner || !data.date) {
          toast('أكمل الحقول الأساسية (*)', 'warn');
          return;
        }

        var fields = [
          ['اسم البرنامج', data.title],
          ['المنفذ', data.owner],
          ['عدد المستفيدين', data.count || '—'],
          ['التاريخ', fmt(data.date)],
          ['المكان', data.place || '—'],
          ['الأهداف', data.goals || '—'],
          ['وصف النشاط', data.desc || '—']
        ];
        
        var boxes = fields.map(function(r) {
          return '<div class="box"><div class="label">' + r[0] + '</div><div class="value">' + String(r[1]).replace(/\n/g, '<br>') + '</div></div>';
        }).join('');
        
        var slots = [];
        for (var i = 0; i < 4; i++) slots.push(witness[i] || null);
        
        var grid = slots.length ? ('<div class="witness-section"><h3 style="margin:0 0 4mm;color:#0f172a;text-align:center">صور الشواهد</h3><div class="witness2x2">' + slots.map(function(s) {
          return s ? ('<div class="slot"><img src="' + s.url + '"></div>') : '<div class="slot"></div>';
        }).join('') + '</div></div>') : '';
        
        var html = '<div class="print-header-edge"><img src="26.png"></div><div class="print-title">تقرير النشاط المدرسي</div><div class="boxes">' + boxes + '</div>' + grid;

        // استخدام العنصر المخصص للطباعة بدلاً من إنشاء عنصر مؤقت
        var printRoot = document.getElementById('printRoot');
        printRoot.innerHTML = '<div class="print-page"><div class="print-wrap">' + html + '</div></div>';
        
        // تصدير المحتوى الموجود في printRoot
        var opt = {
          margin: 10,
          filename: 'تقرير نشاط - ' + (data.title || 'المدرسة') + '.pdf',
          image: {
            type: 'jpeg',
            quality: 0.98
          },
          html2canvas: {
            scale: 2,
            useCORS: true,
            backgroundColor: '#fff'
          },
          jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
          }
        };
        
        // تأخير التصدير لضمان تحميل الصور
        setTimeout(function() {
          html2pdf().set(opt).from(printRoot).save().then(function() {
            toast('تم التصدير');
          }).catch(function(error) {
            console.error('خطأ في التصدير:', error);
            toast('حدث خطأ أثناء التصدير', 'err');
          });
        }, 500);
      };

      function renderSessions() {
        var body = document.getElementById('sessionsBody');
        body.innerHTML = '';
        sessions.forEach(function(s, i) {
          var tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (i + 1) + '</td><td>' + s.day + '</td><td>' + fmt(s.date) + '</td><td>' + s.className + '</td><td>' + s.number + '</td><td>' + s.teacher + '</td><td style="text-align:right">' + s.activities + '</td><td style="text-align:right">' + s.fields + '</td><td class="no-print"><button class="btn danger" data-del="' + i + '">حذف</button></td>';
          body.appendChild(tr);
        });
      }
      renderSessions();

      document.getElementById('sessionsTable').onclick = function(e) {
        var btn = e.target;
        if (btn.tagName !== 'BUTTON' || !btn.hasAttribute('data-del')) return;
        var i = parseInt(btn.getAttribute('data-del'), 10);
        if (!confirm('حذف هذه الحصة؟')) return;
        sessions.splice(i, 1);
        try {
          localStorage.setItem('sessionsData', JSON.stringify(sessions));
        } catch(e) {}
        renderSessions();
        toast('تم الحذف');
      };

      document.getElementById('saveSession').onclick = function(e) {
        e.preventDefault();
        var day = document.getElementById('dayName').value;
        var date = document.getElementById('sessionDate').value;
        var cls = document.getElementById('className').value.trim();
        var num = document.getElementById('sessionNumber').value.trim();
        var teacher = document.getElementById('absentTeacher').value.trim();
        var acts = document.getElementById('activitiesText').value.trim();
        var fields = [];
        if (document.getElementById('basicSkills').checked) fields.push('المهارات الأساسية');
        if (document.getElementById('values').checked) fields.push('القيم والمواطنة الصالحة');
        if (document.getElementById('futureSkills').checked) fields.push('مهارات المستقبل');
        if (!day || !date || !cls || !num || !teacher || !acts || !fields.length) {
          toast('أكمل كل الحقول واختر مجالاً واحداً على الأقل', 'warn');
          return;
        }
        sessions.push({
          day: day,
          date: date,
          className: cls,
          number: num,
          teacher: teacher,
          activities: acts,
          fields: fields.join('، ')
        });
        try {
          localStorage.setItem('sessionsData', JSON.stringify(sessions));
        } catch(e) {}
        renderSessions();
        toast('تم حفظ الحصة');
      };

      document.getElementById('clearAll').onclick = function(e) {
        e.preventDefault();
        if (!sessions.length) {
          toast('لا توجد حصص', 'warn');
          return;
        }
        if (!confirm('مسح جميع الحصص؟')) return;
        sessions = [];
        try {
          localStorage.setItem('sessionsData', JSON.stringify(sessions));
        } catch(e) {}
        renderSessions();
        toast('تم المسح');
      };

      document.getElementById('exportSessions').onclick = function(e) {
        e.preventDefault();
        if (!sessions.length) {
          toast('لا توجد حصص للتصدير', 'warn');
          return;
        }
        var repTeacher = document.getElementById('reportTeacher').value || '';
        var rows = sessions.map(function(s, i) {
          return '<tr><td>' + (i + 1) + '</td><td>' + s.day + '</td><td>' + fmt(s.date) + '</td><td>' + s.className + '</td><td>' + s.number + '</td><td>' + s.teacher + '</td><td style="text-align:right">' + s.activities + '</td><td style="text-align:right">' + s.fields + '</td></tr>';
        }).join('');
        
        var html = '<div class="print-header-edge"><img src="26.png"></div><div class="print-title">تقرير حصص الانتظار</div>' + (repTeacher ? '<div class="print-sub">اسم المعلمة: ' + repTeacher + '</div>' : '') + '<table class="print-table"><colgroup><col style="width:5%"><col style="width:10%"><col style="width:13%"><col style="width:12%"><col style="width:8%"><col style="width:17%"><col style="width:20%"><col style="width:15%"></colgroup><thead><tr><th>م</th><th>اليوم</th><th>التاريخ</th><th>الصف</th><th>الحصة</th><th>المعلمة الغائبة</th><th>ما تم تنفيذه</th><th>المجال</th></tr></thead><tbody>' + rows + '</tbody></table>';

        // استخدام العنصر المخصص للطباعة بدلاً من إنشاء عنصر مؤقت
        var printRoot = document.getElementById('printRoot');
        printRoot.innerHTML = '<div class="print-page"><div class="print-wrap">' + html + '</div></div>';
        
        // تصدير المحتوى الموجود في printRoot
        var opt = {
          margin: 10,
          filename: 'تقرير حصص - ' + (repTeacher || 'المدرسة') + '.pdf',
          image: {
            type: 'jpeg',
            quality: 0.98
          },
          html2canvas: {
            scale: 2,
            useCORS: true,
            backgroundColor: '#fff'
          },
          jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
          }
        };
        
        // تأخير التصدير لضمان تحميل الصور
        setTimeout(function() {
          html2pdf().set(opt).from(printRoot).save().then(function() {
            toast('تم التصدير');
          }).catch(function(error) {
            console.error('خطأ في التصدير:', error);
            toast('حدث خطأ أثناء التصدير', 'err');
          });
        }, 500);
      };
    })();
  </script>
</body>
</html>
