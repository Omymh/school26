<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>التقرير النهائي - المدرسة 26</title>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; direction: rtl; margin: 0; padding: 0; background: #f5f5f5; }
    .report-container { width: 180mm; margin: auto; padding: 10mm; background: #fff; }
    .header { text-align: center; margin-bottom: 10mm; }
    .header img { width: 100%; max-height: 40mm; object-fit: contain; }
    .title { font-size: 20pt; margin-top: 4mm; font-weight: bold; }
    .section { margin-top: 8mm; }
    .boxes { display: grid; grid-template-columns: 1fr 1fr; gap: 4mm; }
    .box { border: 1px solid #000; padding: 3mm; border-radius: 4px; }
    .witnesses { margin-top: 6mm; display: grid; grid-template-columns: 1fr 1fr; gap: 3mm; }
    .witnesses img { width: 100%; height: auto; border: 1px solid #000; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 6mm; }
    th, td { border: 1px solid #000; padding: 2mm; font-size: 10pt; }
    th { background: #eee; }
    .actions { margin: 10px 0; text-align: center; }
    .btn { padding: 10px 16px; background: #0a7; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
    .input { padding: 8px; margin: 4px 0; width: 100%; }
  </style>
</head>
<body>
  <div class="actions">
    <h2>إدخال بيانات النشاط</h2>
    <input id="title" class="input" placeholder="اسم البرنامج / النشاط">
    <input id="owner" class="input" placeholder="المنفذ">
    <input id="count" class="input" placeholder="عدد المستفيدين">
    <input id="date" class="input" type="date">
    <input id="place" class="input" placeholder="المكان">
    <textarea id="goals" class="input" placeholder="الأهداف"></textarea>
    <textarea id="desc" class="input" placeholder="وصف النشاط"></textarea>
    <br>

    <h2>إضافة صور الشواهد</h2>
    <input type="file" id="witnessFiles" accept="image/*" multiple hidden>
    <button class="btn" onclick="document.getElementById('witnessFiles').click()">إضافة الشواهد</button>
    <div id="witnessPreview" class="witnesses"></div>

    <h2>إضافة حصة انتظار</h2>
    <input id="day" class="input" placeholder="اليوم">
    <input id="sessionDate" class="input" type="date">
    <input id="className" class="input" placeholder="الصف">
    <input id="number" class="input" placeholder="رقم الحصة">
    <input id="teacher" class="input" placeholder="المعلمة الغائبة">
    <textarea id="activities" class="input" placeholder="ما تم تنفيذه"></textarea>
    <input id="fields" class="input" placeholder="المجال">
    <button class="btn" onclick="addSession()">حفظ الحصة</button>

    <h2>إجراءات</h2>
    <button class="btn" onclick="exportReport()">تصدير التقرير النهائي (PDF)</button>
  </div>

  <div id="report" class="report-container">
    <div class="header">
      <img src="26.png" alt="ديباجة">
      <div class="title">التقرير النهائي</div>
    </div>
    <div id="activity-section" class="section"></div>
    <div id="witness-section" class="section"></div>
    <div id="sessions-section" class="section"></div>
  </div>

  <script>
    let witnesses = [];
    let sessions = [];

    document.getElementById('witnessFiles').addEventListener('change', function(e) {
      const files = Array.from(e.target.files).slice(0, 4);
      witnesses = [];
      document.getElementById('witnessPreview').innerHTML = "";
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
          witnesses.push({ name: file.name, url: ev.target.result });
          document.getElementById('witnessPreview').innerHTML += `<img src="${ev.target.result}" alt="${file.name}">`;
        };
        reader.readAsDataURL(file);
      });
    });

    function addSession() {
      const s = {
        day: document.getElementById('day').value,
        date: document.getElementById('sessionDate').value,
        className: document.getElementById('className').value,
        number: document.getElementById('number').value,
        teacher: document.getElementById('teacher').value,
        activities: document.getElementById('activities').value,
        fields: document.getElementById('fields').value
      };
      sessions.push(s);
      alert("تمت إضافة الحصة");
    }

    function fmtDate(d) {
      try { return new Date(d).toLocaleDateString('ar-SA'); } catch { return d; }
    }

    function buildActivity() {
      let html = '<div class="boxes">';
      html += `<div class="box"><strong>اسم البرنامج:</strong> ${document.getElementById('title').value}</div>`;
      html += `<div class="box"><strong>المنفذ:</strong> ${document.getElementById('owner').value}</div>`;
      html += `<div class="box"><strong>عدد المستفيدين:</strong> ${document.getElementById('count').value}</div>`;
      html += `<div class="box"><strong>التاريخ:</strong> ${fmtDate(document.getElementById('date').value)}</div>`;
      html += `<div class="box"><strong>المكان:</strong> ${document.getElementById('place').value}</div>`;
      html += `<div class="box"><strong>الأهداف:</strong> ${document.getElementById('goals').value}</div>`;
      html += `<div class="box" style="grid-column: span 2;"><strong>وصف النشاط:</strong> ${document.getElementById('desc').value}</div>`;
      html += '</div>';
      document.getElementById('activity-section').innerHTML = html;
    }

    function buildWitnesses() {
      if (!witnesses.length) return;
      let html = '<div class="witnesses">';
      witnesses.forEach(w => {
        html += `<img src="${w.url}" alt="${w.name}">`;
      });
      html += '</div>';
      document.getElementById('witness-section').innerHTML = '<strong>صور الشواهد:</strong>' + html;
    }

    function buildSessionsTable() {
      if (!sessions.length) return;
      let html = '<table><thead><tr><th>م</th><th>اليوم</th><th>التاريخ</th><th>الصف</th><th>الحصة</th><th>المعلمة الغائبة</th><th>ما تم تنفيذه</th><th>المجال</th></tr></thead><tbody>';
      sessions.forEach((s, i) => {
        html += `<tr><td>${i+1}</td><td>${s.day}</td><td>${fmtDate(s.date)}</td><td>${s.className}</td><td>${s.number}</td><td>${s.teacher}</td><td>${s.activities}</td><td>${s.fields}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('sessions-section').innerHTML = html;
    }

    function exportReport() {
      buildActivity();
      buildWitnesses();
      buildSessionsTable();
      const el = document.getElementById('report');
      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'التقرير-النهائي.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      window.html2pdf().set(opt).from(el).save();
    }
  </script>
</body>
</html>
