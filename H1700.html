<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
@font-face {
  font-family: 'HelveticaNeueW23';
  src: url('fonts/HelveticaNeueW23-Regular.ttf') format('truetype');
}

body {
  margin: 0;
  padding: 0;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
  background: #fff;
}

/* الحاوية العامة اللي نطبعها */
#printArea {
  padding: 10px;
}

/* الهيدر مع الديباجة */
header {
  background: #87092D;
  color: white;
  text-align: center;
  padding: 10px;
}
header img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto 8px;
}
header h3 {
  margin: 3px 0;
  font-size: 18px;
  font-weight: bold;
}

/* الحقول */
label {
  display: block;
  margin: 5px 0 2px;
  font-weight: bold;
  font-size: 12px;
  text-align: center;
}

input,
textarea {
  width: 100%;
  padding: 4px;
  border: 1px solid #c2c1c2;
  border-radius: 4px;
  margin-bottom: 5px;
  box-sizing: border-box;
  font-size: 12px;
  text-align: center;
  background: transparent;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
}

textarea {
  min-height: 40px;
}

/* الأزرار */
button {
  border: none;
  padding: 8px 10px;
  margin: 5px 0;
  cursor: pointer;
  border-radius: 6px;
  width: 100%;
  font-size: 14px;
  font-weight: bold;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
  text-align: center;
}
button.printBtn {
  background: #87092D;
  color: white;
}
button.deleteBtn {
  background: red;
  color: white;
}

/* معاينة الصور */
#waiting-preview img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* زر X فوق الصورة */
.preview-item {
  position: relative;
  display: inline-block;
}
.preview-item button {
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 18px;
  height: 18px;
  font-size: 10px;
  background: red;
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  cursor: pointer;
  padding: 0;
}
</style>
</head>
<body>

<div id="mainContent">

  <!-- ✅ كل ما نريده في الـ PDF داخل printArea -->
  <div id="printArea">

    <!-- ✅ الديباجة 26.png -->
    <header>
      <!-- لو الصورة في نفس المجلد: -->
      <img src="26.png" alt="شعار المدرسة السادسة والعشرون">
      <!-- لو حطيتها في مجلد images استبدلي السطر السابق بهذا:
      <img src="images/26.png" alt="شعار المدرسة السادسة والعشرون">
      -->
      <h3>تقرير تنفيذ استراتيجية تعلّم نشط</h3>
    </header>

    <div id="waiting">

      <!-- إدارة تعليم / المدرسة -->
      <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px; margin-top:10px;">
        <div style="width:200px;"><label>إدارة التعليم</label><input type="text" id="eduDept" /></div>
        <div style="width:200px;"><label>اسم المدرسة</label><input type="text" id="schoolName" /></div>
      </div>

      <!-- الاستراتيجية المستخدمة -->
      <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px;">
        <div style="width:400px;"><label>الاستراتيجية المستخدمة</label><input type="text" /></div>
      </div>

      <!-- بيانات الدرس -->
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
        <div><label>المادة</label><input type="text" /></div>
        <div><label>الوحدة الدراسية</label><input type="text" /></div>
        <div><label>موضوع الدرس</label><input type="text" /></div>
        <div><label>الصف</label><input type="text" /></div>
      </div>

      <!-- توزيع الطالبات / العدد / التاريخ / مدة التنفيذ -->
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
        <div><label>توزيع الطالبات</label><input type="text" /></div>
        <div><label>العدد</label><input type="text" /></div>
        <div><label>تاريخ التنفيذ</label><input type="text" id="date1" placeholder="اختر التاريخ" readonly /></div>
        <div><label>مدة التنفيذ</label><input type="text" /></div>
      </div>

      <!-- وصف الاستراتيجية -->
      <div style="display:grid; grid-template-columns:repeat(1,1fr); gap:5px; margin-top:5px;">
        <div><label>وصف الاستراتيجية</label><input type="text" /></div>
      </div>

      <!-- أهداف الاستراتيجية -->
      <label style="margin-top:5px;">أهداف الاستراتيجية</label>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
        <input type="text" /><input type="text" />
        <input type="text" /><input type="text" />
      </div>

      <!-- خطوات التنفيذ -->
      <label style="margin-top:5px;">خطوات تنفيذ الاستراتيجية</label>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
        <input type="text" /><input type="text" />
        <input type="text" /><input type="text" />
      </div>

      <!-- الأدوات -->
      <label style="margin-top:5px;">الأدوات المستخدمة في تنفيذ الاستراتيجية</label>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
        <input type="text" /><input type="text" />
        <input type="text" /><input type="text" />
      </div>

      <!-- الشواهد -->
      <label style="margin-top:5px;">الشواهد</label>
      <input type="file" multiple accept="image/*" onchange="storeImages(event,'waiting')" />
      <div id="waiting-counter" style="font-size:12px; color:#15445a; font-weight:bold;">عدد الصور المرفوعة: 0 / 4</div>
      <div id="waiting-preview" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;"></div>

      <!-- اسم المعلمة / مديرة المدرسة -->
      <div id="top-director" style="display:flex; gap:10px; justify-content:center; margin:10px 0;">
        <div style="width:200px;"><label>اسم المعلمة</label><input type="text" id="healthGuide" /></div>
        <div style="width:200px;"><label>مديرة المدرسة</label><input type="text" id="schoolDirector" /></div>
      </div>

    </div> <!-- /waiting -->
  </div> <!-- /printArea -->

  <!-- الأزرار (خارج printArea حتى لا تطبع) -->
  <div style="max-width:500px; margin:0 auto 20px;">
    <button class="printBtn" onclick="printPDF()">طباعة التقرير</button>
    <button class="deleteBtn" onclick="clearForm('waiting')">حذف البيانات</button>
  </div>

</div>

<script>
let uploadedImages = { waiting: [] };

document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById('date1');
  if (input) {
    flatpickr(input, {
      locale: 'ar',
      disableMobile: true,
      altInput: true,
      altFormat: 'd-MM-yyyy هـ',
      dateFormat: 'Y-m-d',
      onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates.length > 0) {
          const miladi = selectedDates[0];
          miladi.setDate(miladi.getDate() - 1);
          const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(miladi);
          instance.altInput.value = hijri;
        }
      }
    });
  }
});

function clearForm(tabId) {
  const tab = document.getElementById(tabId);
  if (!tab) return;
  tab.querySelectorAll('input[type="text"],textarea').forEach(input => input.value = '');
  uploadedImages[tabId] = [];
  updateCounter(tabId);
  renderPreview(tabId);
}

function storeImages(event, tabId) {
  const files = event.target.files;
  if (!uploadedImages[tabId]) uploadedImages[tabId] = [];
  if (uploadedImages[tabId].length + files.length > 4) {
    alert('مسموح برفع 4 صور فقط.');
    event.target.value = '';
    return;
  }
  for (let i = 0; i < files.length; i++) {
    const reader = new FileReader();
    reader.onload = function (e) {
      uploadedImages[tabId].push(e.target.result);
      updateCounter(tabId);
      renderPreview(tabId);
    };
    reader.readAsDataURL(files[i]);
  }
}

function updateCounter(tabId) {
  const counter = document.getElementById(tabId + '-counter');
  if (counter) {
    const count = uploadedImages[tabId]?.length || 0;
    counter.textContent = 'عدد الصور المرفوعة: ' + count + ' / 4';
    counter.style.color = count >= 4 ? 'red' : '#15445a';
  }
}

function renderPreview(tabId) {
  const preview = document.getElementById(tabId + '-preview');
  if (!preview) return;
  preview.innerHTML = '';
  (uploadedImages[tabId] || []).forEach((src, index) => {
    const container = document.createElement('div');
    container.className = 'preview-item';
    const img = document.createElement('img');
    img.src = src;
    const btn = document.createElement('button');
    btn.textContent = 'x';
    btn.onclick = () => {
      uploadedImages[tabId].splice(index, 1);
      updateCounter(tabId);
      renderPreview(tabId);
    };
    container.appendChild(img);
    container.appendChild(btn);
    preview.appendChild(container);
  });
}

function printPDF() {
  // ننسخ المنطقة كاملة: الديباجة + التقرير
  const area = document.getElementById('printArea').cloneNode(true);

  // نحط الصور في أسفل التقرير داخل النسخة
  const tabId = 'waiting';
  const tabImages = uploadedImages[tabId] || [];
  if (tabImages.length > 0) {
    const imagesWrapper = document.createElement('div');
    imagesWrapper.style.display = 'flex';
    imagesWrapper.style.flexWrap = 'wrap';
    imagesWrapper.style.justifyContent = 'center';
    imagesWrapper.style.marginTop = '15px';
    imagesWrapper.style.gap = '10px';

    tabImages.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.style.width = '140px';
      img.style.height = '140px';
      img.style.objectFit = 'cover';
      img.style.border = '1px solid #ccc';
      img.style.borderRadius = '4px';
      imagesWrapper.appendChild(img);
    });

    area.appendChild(imagesWrapper);
  }

  // نضيف الحاوية إلى wrapper مع خلفية التقرير
  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';
  wrapper.style.width = '210mm';
  wrapper.style.minHeight = '296.5mm';
  wrapper.style.padding = '25mm 10mm 15mm 10mm';
  wrapper.style.boxSizing = 'border-box';
  wrapper.style.backgroundImage = 'url("images/background.png")'; /* لو ما عندك خلفية احذفي هذا السطر */
  wrapper.style.backgroundSize = 'cover';
  wrapper.style.backgroundRepeat = 'no-repeat';
  wrapper.style.backgroundPosition = 'center';
  wrapper.appendChild(area);

  html2pdf().set({
    margin: 0,
    filename: 'تقريب-استراتيجية-تعلم-نشط.pdf',
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { scale: 3, useCORS: true, backgroundColor: null, scrollY: 0 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
  }).from(wrapper).save();
}
</script>

</body>
</html>
